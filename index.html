<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trình Chỉnh Sửa Bộ Lọc Yuusei</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- CodeMirror 5 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/dialog/dialog.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/matchesonscrollbar.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/mode/simple.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/search.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/search/jump-to-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/dialog/dialog.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .CodeMirror {
            height: 100%;
            font-family: 'JetBrains Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
        }

        /* --- Yuusei Optimized Color Scheme --- */

        /* 1. Comments & Headers */
        .cm-adblock-comment { color: #6272a4 !important; font-style: italic; } /* Muted Blue */
        /* Revert Section Header to match Comment per user request */
        .cm-adblock-section-header {
            color: #6272a4 !important;
            font-style: italic;
        }

        /* 2. Hosts (0.0.0.0) */
        .cm-adblock-ip { color: #ff5555 !important; font-weight: bold; } /* Red IP */
        .cm-adblock-host { color: #f8f8f2 !important; } /* White Host */

        /* 3. Blocking Rules (||...) */
        .cm-adblock-anchor { color: #ff5555 !important; font-weight: bold; } /* Red Anchors || */
        .cm-adblock-separator { color: #ff5555 !important; font-weight: bold; } /* Red Separator ^ */
        .cm-adblock-wildcard { color: #f1fa8c !important; } /* Yellow * */
        .cm-adblock-domain { color: #f8f8f2 !important; } /* White text */

        /* 4. Exception Rules (@@...) */
        .cm-adblock-exception-marker { color: #50fa7b !important; font-weight: bold; } /* Green @@ */

        /* 5. Element Hiding (##...) */
        .cm-adblock-hiding-sep {
            color: #8be9fd !important; /* Cyan */
            font-weight: bold;
            background: rgba(139, 233, 253, 0.1);
        }
        /* CSS Selectors */
        .cm-adblock-selector-id { color: #ffb86c !important; font-weight: bold; } /* Orange #id */
        .cm-adblock-selector-class { color: #8be9fd !important; } /* Cyan .class */
        .cm-adblock-selector-tag { color: #ff79c6 !important; } /* Pink tag */
        .cm-adblock-selector-attr { color: #f1fa8c !important; font-style: italic; } /* Yellow [attr] */
        .cm-adblock-selector-pseudo { color: #bd93f9 !important; } /* Purple :pseudo */

        /* 6. Scriptlets (+js) */
        .cm-adblock-js-marker { color: #bd93f9 !important; font-weight: bold; } /* Purple +js */
        .cm-adblock-js-name { color: #50fa7b !important; font-weight: bold; } /* Green Function */
        .cm-adblock-js-args { color: #f1fa8c !important; } /* Yellow Args */

        /* 7. Options ($...) */
        .cm-adblock-opt-sep { color: #ffb86c !important; font-weight: bold; } /* Orange $ */
        .cm-adblock-opt-key { color: #bd93f9 !important; font-style: italic; } /* Purple Key */
        .cm-adblock-opt-op { color: #f8f8f2 !important; } /* White Op */
        .cm-adblock-opt-val { color: #f1fa8c !important; } /* Yellow Val */

        /* Search Dialog Dark Theme */
        .CodeMirror-dialog {
            background: #282a36;
            color: #f8f8f2;
            border-bottom: 1px solid #6272a4;
            padding: 10px;
            font-family: inherit;
            position: absolute;
            top: 0; left: 0; right: 0;
            z-index: 15;
        }
        .CodeMirror-dialog input {
            background: #44475a;
            border: 1px solid #6272a4;
            color: #f8f8f2;
            border-radius: 4px;
            outline: none;
            padding: 4px 8px;
            margin-right: 5px;
        }
        .CodeMirror-dialog input:focus {
            border-color: #8be9fd;
        }
        .CodeMirror-dialog button {
            background: #6272a4;
            color: #f8f8f2;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 4px;
            font-size: 12px;
        }
        .CodeMirror-dialog button:hover {
            background: #50fa7b;
            color: #282a36;
        }
        .CodeMirror-search-hint {
            display: none; /* Hide hint text to save space on mobile */
        }

        /* Mobile Tweaks */
        @media (max-width: 640px) {
            .mobile-hide-text span { display: none; }
            .CodeMirror {
                font-size: 16px; /* Better for mobile reading/editing */
            }
        }

        .CodeMirror-cursors {
            visibility: visible !important;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: { 900: '#111827', 800: '#1f2937', 700: '#374151' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="bg-gray-800 border-b border-gray-700 p-2 sm:p-4 shadow-lg flex justify-between items-center z-10 shrink-0">
        <div class="flex items-center space-x-2 sm:space-x-3">
            <div class="bg-indigo-600 p-1.5 sm:p-2 rounded-lg shadow-lg shadow-indigo-500/50">
                <i class="fas fa-shield-alt text-lg sm:text-xl text-white"></i>
            </div>
            <div class="hidden sm:block">
                <h1 class="text-lg font-bold tracking-tight text-white leading-tight">Yuusei Editor</h1>
                <p class="text-[10px] text-gray-400">Quản lý bộ lọc</p>
            </div>
            <div class="sm:hidden">
                <h1 class="text-base font-bold text-white">Yuusei</h1>
            </div>
        </div>

        <div class="flex items-center space-x-2">
            <!-- Search -->
            <button onclick="triggerSearch()" class="bg-gray-700 hover:bg-gray-600 text-gray-200 p-2 rounded-lg w-9 h-9 flex items-center justify-center transition" title="Tìm kiếm">
                <i class="fas fa-search"></i>
            </button>

            <!-- Reload -->
            <button onclick="loadFile()" id="btn-reload" class="bg-gray-700 hover:bg-gray-600 text-gray-200 px-3 py-2 rounded-lg text-sm font-semibold transition flex items-center gap-2 mobile-hide-text" title="Tải lại">
                <i class="fas fa-sync-alt"></i> <span>Tải lại</span>
            </button>

            <!-- Save -->
            <button onclick="saveFile()" id="btn-save" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white px-3 py-2 rounded-lg text-sm font-bold shadow-lg shadow-indigo-500/30 transition transform active:scale-95 flex items-center gap-2 mobile-hide-text" title="Lưu">
                <i class="fas fa-save"></i> <span>Lưu</span>
            </button>

            <!-- Settings -->
            <button onclick="toggleSettings()" class="bg-gray-700 hover:bg-gray-600 text-gray-300 p-2 rounded-lg w-9 h-9 flex items-center justify-center transition" title="Cài đặt">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-grow flex flex-col overflow-hidden relative bg-gray-900">
        <!-- Status Bar -->
        <div class="bg-gray-800 border-b border-gray-700 px-3 py-1 text-[10px] sm:text-xs font-mono text-gray-400 flex justify-between items-center select-none shrink-0 overflow-x-auto whitespace-nowrap">
            <div class="flex items-center gap-3">
                <span id="status" class="flex items-center gap-1.5 font-medium text-gray-300">
                    <span class="w-1.5 h-1.5 rounded-full bg-gray-500 block"></span> Sẵn sàng
                </span>
                <span id="file-sha" class="text-gray-500 hidden sm:inline">SHA: ---</span>
            </div>
            <div class="flex items-center gap-3">
                <span id="stats-info">0 dòng</span>
            </div>
        </div>

        <!-- Editor Container -->
        <div class="relative flex-grow h-full overflow-hidden">
            <textarea id="editor" class="hidden"></textarea>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4 transition-opacity opacity-0 pointer-events-none">
        <div class="bg-gray-800 border border-gray-700 rounded-2xl shadow-2xl p-5 w-full max-w-sm transform scale-95 transition-transform duration-200" id="settings-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-white flex items-center gap-2">
                    <i class="fas fa-cog text-indigo-400"></i> Cài Đặt
                </h2>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>

            <div class="mb-4">
                <label class="block text-gray-300 text-xs font-semibold mb-2">GitHub Token (PAT)</label>
                <input type="password" id="github-token" class="bg-gray-900 border border-gray-600 text-white text-sm rounded-lg block w-full p-2.5 focus:ring-1 focus:ring-indigo-500 outline-none" placeholder="ghp_...">
                <p class="text-[10px] text-gray-500 mt-1">Token cần quyền `repo`. Lưu cục bộ.</p>
            </div>

            <div class="flex justify-end gap-2">
                <button onclick="toggleSettings()" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-white text-xs font-medium rounded-lg">Đóng</button>
                <button onclick="saveSettings()" class="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded-lg shadow-lg shadow-indigo-500/30">Lưu</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 left-5 sm:left-auto bg-gray-800 border border-gray-700 text-white px-4 py-3 rounded-xl shadow-2xl transform translate-y-24 opacity-0 transition-all duration-300 flex items-center gap-3 z-50 sm:max-w-sm">
        <div id="toast-icon" class="text-xl"></div>
        <div>
            <h4 id="toast-title" class="font-bold text-sm">Thông báo</h4>
            <p id="toast-message" class="text-xs text-gray-300">Nội dung</p>
        </div>
    </div>

    <script>
        // Configuration
        const INJECTED_REPO_NAME = '{{REPO_NAME}}';
        const FILE_PATH = 'Yuusei.txt';

        let currentSha = '';
        let repoName = '';
        let editor = null;

        // Define Advanced Adblock Mode with Granular Tokens
        function defineAdblockMode() {
            CodeMirror.defineSimpleMode("adblock", {
                start: [
                    // --- Header Comments (Start with ! --- or ! [Title]) ---
                    {regex: /^!\s*-{3,}.*$/, token: "adblock-section-header"},
                    {regex: /^!\s*Title:.*$/, token: "adblock-section-header"},

                    // --- Normal Comments ---
                    {regex: /^!.*$/, token: "adblock-comment"},
                    {regex: /^\[.*\]$/, token: "adblock-header"},

                    // --- Host File Syntax (0.0.0.0 domain) ---
                    {regex: /^(?:0\.0\.0\.0|127\.0\.0\.1|::1)(?=\s)/, token: "adblock-ip", push: "hosts"},

                    // --- Exceptions ---
                    {regex: /^@@/, token: "adblock-exception-marker", push: "network_rule"},

                    // --- Element Hiding / Scriptlets ---
                    // Detect separators. Note: ###id is matched as ## + #id by the logic below if we are careful.
                    // We must ensure we don't consume the domain if it contains special chars, but adblock domains usually don't contain # unless it's the separator.

                    // Match the separator and switch to selector mode
                    {regex: /#@?#|#\?#|#%#/, token: "adblock-hiding-sep", next: "selector"},

                    // --- Network Rules ---
                    // Anchors
                    {regex: /\|\||\|/, token: "adblock-anchor"},

                    // Separator
                    {regex: /\^/, token: "adblock-separator"},

                    // Options start
                    {regex: /\$/, token: "adblock-opt-sep", next: "options"},

                    // Wildcard
                    {regex: /\*/, token: "adblock-wildcard"},

                    // Domain part
                    {regex: /[^!|#$^*]+/, token: "adblock-domain"},
                ],

                // --- Hosts Mode ---
                hosts: [
                    {regex: /#.*$/, token: "adblock-comment", pop: true},
                    {regex: /\s+/, token: "whitespace"},
                    {regex: /$/, pop: true},
                    {regex: /\S+/, token: "adblock-host"}
                ],

                // --- Network Rule (inside Exception) ---
                network_rule: [
                    {regex: /\$/, token: "adblock-opt-sep", next: "options"},
                    {regex: /\|\||\|/, token: "adblock-anchor"},
                    {regex: /\^/, token: "adblock-separator"},
                    {regex: /\*/, token: "adblock-wildcard"},
                    {regex: /$/, pop: true},
                    {regex: /[^$|^*]+/, token: "adblock-domain"}
                ],

                // --- Selector / Scriptlet Mode ---
                selector: [
                    // Scriptlet: +js(...)
                    {regex: /\+js\(/, token: "adblock-js-marker", push: "scriptlet"},

                    // CSS Selectors
                    {regex: /#[\w-]+/, token: "adblock-selector-id"}, // IDs
                    {regex: /\.[\w-]+/, token: "adblock-selector-class"}, // Classes
                    {regex: /\[[^\]]+\]/, token: "adblock-selector-attr"}, // Attributes
                    {regex: /:{1,2}[\w-]+(\(.*\))?/, token: "adblock-selector-pseudo"}, // Pseudos
                    {regex: /\w+/, token: "adblock-selector-tag"}, // Tags
                    {regex: />|\+|~/, token: "adblock-separator"}, // Combinators

                    {regex: /$/, pop: true},
                    {regex: /\s+/, token: "whitespace"}
                ],

                // --- Scriptlet Args ---
                scriptlet: [
                    {regex: /\)/, token: "adblock-js-marker", pop: true},
                    {regex: /,/, token: "adblock-separator"},
                    {regex: /'[^']*'|"[^"]*"/, token: "adblock-js-args"},
                    {regex: /[^,)]+/, token: "adblock-js-name"}
                ],

                // --- Options Mode ---
                options: [
                    {regex: /$/, pop: true},
                    {regex: /,/, token: "adblock-opt-sep"},
                    {regex: /(?:domain|image|script|third-party|xmlhttprequest|stylesheet|object|subdocument|media|font|popup|network|generichide|genericblock|document|elemhide|webrtc|other|csp|badfilter|ping|websocket|rewrite|replace|sitekey)\b/, token: "adblock-opt-key"},
                    {regex: /[=~]/, token: "adblock-opt-op"},
                    {regex: /[^,=~]+/, token: "adblock-opt-val"}
                ]
            });
        }

        // Initialize CodeMirror
        function initEditor() {
            defineAdblockMode();

            const textarea = document.getElementById("editor");
            editor = CodeMirror.fromTextArea(textarea, {
                mode: "adblock",
                theme: "dracula",
                lineNumbers: true,
                styleActiveLine: true,
                matchBrackets: true,
                lineWrapping: true,
                tabSize: 4,
                indentWithTabs: false,
                // Better mobile support attempts
                inputStyle: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ? "textarea" : "contenteditable",
            });

            // Update stats on change
            editor.on('change', () => {
                const lines = editor.lineCount();
                document.getElementById('stats-info').textContent = `${lines.toLocaleString()} dòng`;
            });
        }

        function triggerSearch() {
            if (editor) {
                editor.execCommand('find');
            }
        }

        function getRepoName() {
            if (INJECTED_REPO_NAME && !INJECTED_REPO_NAME.includes('{{')) {
                return INJECTED_REPO_NAME;
            }
            const hostname = window.location.hostname;
            const pathParts = window.location.pathname.split('/').filter(p => p);

            if (hostname.includes('github.io')) {
                const user = hostname.split('.')[0];
                let repo = pathParts[0];

                if (!repo) {
                    return `${user}/${user}.github.io`;
                }
                return `${user}/${repo}`;
            }
            return null;
        }

        function getApiUrl() {
            repoName = getRepoName();
            if (!repoName) {
                console.error('Could not determine Repo Name');
                return null;
            }
            return `https://api.github.com/repos/${repoName}/contents/${FILE_PATH}`;
        }

        // UI Helpers
        function showToast(title, message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const titleEl = document.getElementById('toast-title');
            const msgEl = document.getElementById('toast-message');

            titleEl.textContent = title;
            msgEl.textContent = message;

            if (type === 'success') {
                icon.innerHTML = '<i class="fas fa-check-circle text-green-400"></i>';
                toast.classList.add('border-green-900');
            } else if (type === 'error') {
                icon.innerHTML = '<i class="fas fa-exclamation-circle text-red-400"></i>';
                toast.classList.add('border-red-900');
            } else {
                icon.innerHTML = '<i class="fas fa-info-circle text-blue-400"></i>';
            }

            toast.classList.remove('translate-y-24', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-24', 'opacity-0'), 4000);
        }

        function setStatus(msg, type = 'ready') {
            const el = document.getElementById('status');
            let color = 'bg-gray-500';
            if (type === 'loading') color = 'bg-yellow-500 animate-pulse';
            if (type === 'success') color = 'bg-green-500';
            if (type === 'error') color = 'bg-red-500';
            el.innerHTML = `<span class="w-1.5 h-1.5 rounded-full ${color} block"></span> ${msg}`;
        }

        // Modal Logic
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const content = document.getElementById('settings-content');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0', 'pointer-events-none');
                    content.classList.remove('scale-95'); content.classList.add('scale-100');
                }, 10);
            } else {
                modal.classList.add('opacity-0', 'pointer-events-none');
                content.classList.remove('scale-100'); content.classList.add('scale-95');
                setTimeout(() => modal.classList.add('hidden'), 200);
            }
        }

        function saveSettings() {
            const token = document.getElementById('github-token').value.trim();
            if (token) {
                localStorage.setItem('github_token', token);
                showToast('Thành công', 'Đã lưu Token!');
                toggleSettings();
                loadFile();
            } else {
                showToast('Lỗi', 'Vui lòng nhập Token!', 'error');
            }
        }

        // GitHub API Logic
        async function loadFile() {
            const url = getApiUrl();
            if (!url) {
                setStatus('Lỗi cấu hình', 'error');
                return;
            }

            setStatus('Đang tải...', 'loading');
            editor.setOption('readOnly', true);

            try {
                const token = localStorage.getItem('github_token');
                const headers = token ? { 'Authorization': `token ${token}` } : {};
                const response = await fetch(`${url}?t=${new Date().getTime()}`, { headers });

                if (!response.ok) {
                    if (response.status === 404) throw new Error('Không tìm thấy tệp Yuusei.txt');
                    if (response.status === 401) throw new Error('Token không hợp lệ');
                    throw new Error(`Lỗi mạng: ${response.status}`);
                }

                const data = await response.json();
                currentSha = data.sha;
                document.getElementById('file-sha').textContent = `SHA: ${currentSha.substring(0, 7)}`;

                // Decode UTF-8 correctly
                const content = new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0)));

                editor.setValue(content);
                editor.clearHistory(); // Clear undo history after load
                editor.setOption('readOnly', false);
                setStatus('Sẵn sàng', 'success');
            } catch (error) {
                console.error(error);
                setStatus('Lỗi tải', 'error');
                showToast('Lỗi tải', error.message, 'error');
            } finally {
                editor.setOption('readOnly', false);
            }
        }

        async function saveFile() {
            const token = localStorage.getItem('github_token');
            if (!token) {
                showToast('Yêu cầu', 'Cần nhập Token trong cài đặt!', 'error');
                toggleSettings();
                return;
            }
            if (!confirm('Bạn có chắc chắn muốn lưu thay đổi?')) return;

            const url = getApiUrl();
            if (!url) {
                 showToast('Lỗi', 'Không xác định được Repository', 'error');
                 return;
            }

            setStatus('Đang lưu...', 'loading');
            document.getElementById('btn-save').disabled = true;

            try {
                const content = editor.getValue();
                const encodedContent = btoa(String.fromCharCode(...new TextEncoder().encode(content)));

                const body = {
                    message: `Update ${FILE_PATH} via Web Editor`,
                    content: encodedContent,
                    sha: currentSha
                };

                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || 'Lỗi không xác định khi lưu');
                }

                const data = await response.json();
                currentSha = data.content.sha;
                document.getElementById('file-sha').textContent = `SHA: ${currentSha.substring(0, 7)}`;
                setStatus('Đã lưu', 'success');
                showToast('Thành công', 'Đã lưu thay đổi lên GitHub!');
            } catch (error) {
                console.error(error);
                setStatus('Lỗi lưu', 'error');
                showToast('Thất bại', error.message, 'error');
            } finally {
                document.getElementById('btn-save').disabled = false;
                setTimeout(() => {
                    const statusText = document.getElementById('status').innerText;
                    if(statusText.includes('Đang lưu')) setStatus('Sẵn sàng');
                }, 500);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initEditor();
            const token = localStorage.getItem('github_token');
            if (token) document.getElementById('github-token').value = token;
            setTimeout(loadFile, 100);
        });
    </script>
</body>
</html>
