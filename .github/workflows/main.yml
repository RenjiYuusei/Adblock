name: Update Yuusei Filter and Create Release

on:
  push:
    paths:
      - 'Yuusei.txt'
  schedule:
    - cron: '0 0 * * *'  # Run daily at 00:00 UTC
  workflow_dispatch:
    inputs:
      release_note:
        description: 'Custom release notes'
        required: false
        type: string
      force_update:
        description: 'Force update even if no changes'
        required: false
        type: boolean
        default: false

env:
  FILTER_FILE: Yuusei.txt
  MIN_RULES: 10  # Minimum number of rules required
  KEEP_RELEASES: 10  # Number of recent releases to keep

jobs:
  update-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up timezone and variables
        run: |
          sudo ln -sf /usr/share/zoneinfo/Asia/Ho_Chi_Minh /etc/localtime
          # Date formats
          echo "DATE=$(date +"%d-%m-%Y")" >> $GITHUB_ENV
          echo "TIME=$(date +"%H:%M:%S")" >> $GITHUB_ENV
          echo "RELEASE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV
          echo "YEAR=$(date +"%Y")" >> $GITHUB_ENV
          # Repository info
          echo "REPO_NAME=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV
          echo "AUTHOR_NAME=${GITHUB_REPOSITORY%/*}" >> $GITHUB_ENV

      - name: Check existing release
        id: check_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh release view "v${{ env.RELEASE_DATE }}" &>/dev/null; then
            echo "EXISTS=true" >> $GITHUB_ENV
            # Delete existing release if it's from today
            created_at=$(gh release view "v${{ env.RELEASE_DATE }}" --json createdAt -q .createdAt)
            today=$(date -u +%Y-%m-%d)
            release_date=$(date -u -d "$created_at" +%Y-%m-%d)
            if [ "$release_date" = "$today" ]; then
              echo "Deleting today's existing release..."
              gh release delete "v${{ env.RELEASE_DATE }}" --yes || true
              echo "EXISTS=false" >> $GITHUB_ENV
            fi
          else
            echo "EXISTS=false" >> $GITHUB_ENV
          fi

      - name: Validate filter file
        id: validate
        run: |
          # Enhanced validation
          if [ ! -f "${{ env.FILTER_FILE }}" ]; then
            echo "Error: Filter file not found!"
            exit 1
          fi
          
          # Check file size and format
          FILE_SIZE=$(stat -f%z "${{ env.FILTER_FILE }}" 2>/dev/null || stat -c%s "${{ env.FILTER_FILE }}")
          if [ "$FILE_SIZE" -lt 100 ]; then
            echo "Error: Filter file is too small (< 100 bytes)!"
            exit 1
          fi
          
          # Validate header format
          if ! grep -q "^! Title:" "${{ env.FILTER_FILE }}" || \
             ! grep -q "^! Version:" "${{ env.FILTER_FILE }}" || \
             ! grep -q "^! Last modified:" "${{ env.FILTER_FILE }}"; then
            echo "Error: Required header information missing!"
            exit 1
          fi
          
          # Count rules and validate
          RULE_COUNT=$(grep -c "^[^!]" "${{ env.FILTER_FILE }}" || true)
          if [ "$RULE_COUNT" -lt "${{ env.MIN_RULES }}" ]; then
            echo "Error: Filter contains too few rules (minimum: ${{ env.MIN_RULES }})!"
            exit 1
          fi
          echo "RULE_COUNT=$RULE_COUNT" >> $GITHUB_ENV
          
          # Check for syntax errors
          SYNTAX_ERRORS=$(grep -n "^[^!#@|]*[^a-zA-Z0-9.*?^$@#|=/,&_-]" "${{ env.FILTER_FILE }}" || true)
          if [ ! -z "$SYNTAX_ERRORS" ]; then
            echo "Warning: Possible syntax errors found:"
            echo "$SYNTAX_ERRORS"
          fi

      - name: Update filter metadata
        id: update_file
        run: |
          # Create temporary file
          temp_file=$(mktemp)
          
          # Update metadata with backup
          cp "${{ env.FILTER_FILE }}" "${FILTER_FILE}.bak"
          sed -E "
            s/^! Version:.*/! Version: ${{ env.DATE }}/
            s/^! Last modified:.*/! Last modified: ${{ env.DATE }} ${{ env.TIME }}/
            s/^! Updated by:.*/! Updated by: GitHub Actions/
          " "${{ env.FILTER_FILE }}" > "$temp_file"
          
          # Calculate new checksum
          CHECKSUM=$(sha256sum "$temp_file" | cut -d' ' -f1)
          sed "s/^! Checksum:.*/! Checksum: $CHECKSUM/" "$temp_file" > "${{ env.FILTER_FILE }}"
          
          # Extract and validate statistics
          echo "NETWORK_RULES=$(grep -c "^||" "${{ env.FILTER_FILE }}" || true)" >> $GITHUB_ENV
          echo "COSMETIC_RULES=$(grep -c "##" "${{ env.FILTER_FILE }}" || true)" >> $GITHUB_ENV
          echo "WHITELIST_RULES=$(grep -c "^@@" "${{ env.FILTER_FILE }}" || true)" >> $GITHUB_ENV
          
          # Check for changes
          if [[ "${{ github.event.inputs.force_update }}" == "true" ]] || ! git diff --quiet "${{ env.FILTER_FILE }}"; then
            echo "CHANGED=true" >> $GITHUB_ENV
          else
            echo "CHANGED=false" >> $GITHUB_ENV
          fi
          
          rm "$temp_file"

      - name: Generate badges
        if: env.CHANGED == 'true'
        run: |
          mkdir -p .github/badges
          
          # Enhanced badge creation function
          create_badge() {
            local label=$1
            local message=$2
            local color=$3
            local filename=".github/badges/${label// /_}.json"
            echo "{
              \"schemaVersion\": 1,
              \"label\": \"$label\",
              \"message\": \"$message\",
              \"color\": \"$color\",
              \"style\": \"flat-square\"
            }" > "$filename"
          }
          
          create_badge "version" "${{ env.RELEASE_DATE }}" "blue"
          create_badge "rules" "${{ env.RULE_COUNT }}" "brightgreen"
          create_badge "updated" "${{ env.DATE }}" "success"
          create_badge "network rules" "${{ env.NETWORK_RULES }}" "informational"
          create_badge "cosmetic rules" "${{ env.COSMETIC_RULES }}" "yellow"
          create_badge "whitelist rules" "${{ env.WHITELIST_RULES }}" "orange"

      - name: Update README.md
        if: env.CHANGED == 'true'
        run: |
          cat > README.md << 'EOF'
          <div align="center">
          
          # ğŸ›¡ï¸ Yuusei Filter List
          
          ![Version](https://img.shields.io/badge/version-${{ env.RELEASE_DATE }}-blue?style=flat-square)
          ![Rules](https://img.shields.io/badge/rules-${{ env.RULE_COUNT }}-brightgreen?style=flat-square)
          ![Updated](https://img.shields.io/badge/updated-${{ env.DATE }}-success?style=flat-square)
          [![License](https://img.shields.io/badge/license-GPL--3.0-orange?style=flat-square)](LICENSE)
          
          A powerful and efficient filter list for ad blockers, meticulously maintained and automatically updated.
          
          [ğŸ“¦ Install](#-installation) â€¢ [ğŸ“Š Statistics](#-statistics) â€¢ [ğŸ“ Features](#-features) â€¢ [ğŸ“œ License](#-license)
          
          </div>
          
          ## ğŸ“¦ Installation
          
          ### âš¡ Quick Install
          Choose your ad blocker:
          
          <div align="center">
          
          [![Install with uBlock Origin](https://img.shields.io/badge/install%20with-uBlock%20Origin-red?style=for-the-badge&logo=ublock-origin)](https://raw.githubusercontent.com/${{ github.repository }}/main/Yuusei.txt)
          [![Install with AdGuard](https://img.shields.io/badge/install%20with-AdGuard-green?style=for-the-badge&logo=adguard)](https://subscribe.adblockplus.org/?location=https://raw.githubusercontent.com/${{ github.repository }}/main/Yuusei.txt)
          
          </div>
          
          ### ğŸ”§ Manual Setup
          Add this URL to your ad blocker's filter lists:
          ```
          https://raw.githubusercontent.com/${{ github.repository }}/main/Yuusei.txt
          ```
          
          ## ğŸ“Š Statistics
          
          ### ğŸ“ˆ Current Status
          
          | Metric | Count |
          |--------|-------|
          | Total Rules | ${{ env.RULE_COUNT }} |
          | Network Rules | ${{ env.NETWORK_RULES }} |
          | Cosmetic Rules | ${{ env.COSMETIC_RULES }} |
          | Whitelist Rules | ${{ env.WHITELIST_RULES }} |
          
          ### â° Update Schedule
          - **Version**: ${{ env.RELEASE_DATE }}
          - **Last Updated**: ${{ env.DATE }} ${{ env.TIME }} (Vietnam/ICT)
          - **Auto Updates**: Daily at 07:00 (Vietnam/ICT)
          - **Manual Updates**: On-demand for critical changes
          
          ## ğŸ›¡ï¸ Protection Features
          
          ### ğŸš« Ad Blocking
          - Comprehensive ad server blocking
          - Sponsored content removal
          - Pop-up & overlay prevention
          
          ### ğŸ”’ Privacy Shield
          - Tracker blocking
          - Anti-fingerprinting
          - Analytics protection
          
          ### âš¡ Performance
          - Faster page loads
          - Reduced bandwidth usage
          - Smoother browsing
          
          ### ğŸ”„ Maintenance
          - Daily updates
          - Strict validation
          - Quick fixes for false positives
          
          ## ğŸ¤ Contributing
          
          ### ğŸ› Report Issues
          Found a problem? [Open an issue](https://github.com/${{ github.repository }}/issues)
          
          ### ğŸ’¡ Suggest Rules
          Have ideas? [Create a pull request](https://github.com/${{ github.repository }}/pulls)
          
          ### ğŸ’¬ Get Help
          Need assistance? [Join discussions](https://github.com/${{ github.repository }}/discussions)
          
          ## ğŸ“œ License
          
          Licensed under [GNU GPL v3.0](LICENSE)
          
          ## â­ Support Us
          
          If you find Yuusei Filter helpful:
          - Star the repository
          - Share with others
          - Report issues
          - Contribute improvements
          
          ---
          
          <div align="center">
          
          Made with â¤ï¸ by [Yuusei](https://github.com/${{ env.AUTHOR_NAME }}) | Â© ${{ env.YEAR }}
          
          <sub>Updated daily by GitHub Actions ğŸ¤–</sub>
          
          </div>
          EOF

      - name: Commit and push changes
        if: env.CHANGED == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "${{ env.FILTER_FILE }}" README.md .github/badges || true
          git commit -m "ğŸ”„ Auto update (Version: ${{ env.DATE }})"
          git push

      - name: Create GitHub Release
        if: env.CHANGED == 'true' && env.EXISTS == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Generate enhanced changelog
          if [ -n "${{ github.event.inputs.release_note }}" ]; then
            CHANGELOG="${{ github.event.inputs.release_note }}"
          else
            CHANGELOG="## ğŸ”„ Update Summary (v${{ env.RELEASE_DATE }})
          
          ### ğŸ“Š Statistics
          | Metric | Count |
          |--------|-------|
          | Total Rules | ${{ env.RULE_COUNT }} |
          | Network Rules | ${{ env.NETWORK_RULES }} |
          | Cosmetic Rules | ${{ env.COSMETIC_RULES }} |
          | Whitelist Rules | ${{ env.WHITELIST_RULES }} |
          
          ### ğŸ” Changes
          - âœ¨ Updated filter version to ${{ env.DATE }}
          - ğŸ”’ Recalculated checksum
          - âœ… Validated all rules
          - ğŸ§¹ Optimized filter structure
          
          ### ğŸ“ Notes
          - ğŸ¤– Automatic update via GitHub Actions
          - ğŸ›¡ï¸ All rules validated and optimized
          - ğŸ“ˆ Performance improvements
          
          ### ğŸ“¦ Installation
          \`\`\`
          https://raw.githubusercontent.com/${{ github.repository }}/main/Yuusei.txt
          \`\`\`
          "
          fi
          
          # Create release with assets
          gh release create "v${{ env.RELEASE_DATE }}" \
            --title "ğŸ“¦ Yuusei Filter v${{ env.RELEASE_DATE }}" \
            --notes "$CHANGELOG" \
            --target ${{ github.sha }} \
            "${{ env.FILTER_FILE }}"

      - name: Cleanup old releases
        if: env.CHANGED == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Keep latest N releases
          releases=$(gh release list -L 100 | tail -n +$((${{ env.KEEP_RELEASES }} + 1)) | cut -f1)
          for release in $releases; do
            gh release delete $release --yes || true
          done
