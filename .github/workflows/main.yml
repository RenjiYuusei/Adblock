name: Update Yuusei Filter

on:
    push:
        paths:
            - 'Yuusei.txt'
    schedule:
        - cron: '0 0,12 * * *' # Ch·∫°y 2 l·∫ßn m·ªói ng√†y l√∫c 00:00 v√† 12:00 UTC
    workflow_dispatch:
        inputs:
            force_update:
                description: 'C·∫≠p nh·∫≠t b·∫Øt bu·ªôc ngay c·∫£ khi kh√¥ng c√≥ thay ƒë·ªïi'
                required: false
                type: boolean
                default: false

env:
    FILTER_FILE: Yuusei.txt
    MIN_RULES: 10
    TIMEZONE: 'Asia/Ho_Chi_Minh'
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
    update-filter:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup environment
              id: setup
              run: |
                  sudo ln -sf /usr/share/zoneinfo/${{ env.TIMEZONE }} /etc/localtime
                  {
                    echo "DATE=$(date +'%d-%m-%Y')"
                    echo "TIME=$(date +'%H:%M:%S')"
                    echo "YEAR=$(date +'%Y')"
                    echo "REPO_NAME=${GITHUB_REPOSITORY#*/}"
                    echo "AUTHOR_NAME=${GITHUB_REPOSITORY%/*}"
                    echo "FULL_VERSION=$(date +'%Y.%m.%d')"
                  } >> $GITHUB_ENV

            - name: Get contributors info
              id: contributors
              run: |
                  contributors=$(gh api repos/${{ github.repository }}/contributors --jq '[.[] | {login: .login, avatar_url: .avatar_url, contributions: .contributions, html_url: .html_url}]')
                  echo "CONTRIBUTORS=$contributors" >> $GITHUB_ENV
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Remove duplicate rules
              id: deduplicate
              run: |
                  temp_file=$(mktemp)
                  grep "^!" "${{ env.FILTER_FILE }}" > "$temp_file"
                  grep -v "^!" "${{ env.FILTER_FILE }}" | sort -u >> "$temp_file"
                  original_count=$(grep -cv "^!" "${{ env.FILTER_FILE }}")
                  new_count=$(grep -cv "^!" "$temp_file")
                  removed_count=$((original_count - new_count))
                  echo "REMOVED_DUPLICATES=$removed_count" >> $GITHUB_ENV
                  mv "$temp_file" "${{ env.FILTER_FILE }}"

            - name: Validate filter file
              id: validate
              run: |
                  log_error() {
                    echo "::error::$1"
                    exit 1
                  }

                  [ -f "${{ env.FILTER_FILE }}" ] || log_error "Kh√¥ng t√¨m th·∫•y file filter!"
                  FILE_SIZE=$(stat -f%z "${{ env.FILTER_FILE }}" 2>/dev/null || stat -c%s "${{ env.FILTER_FILE }}")
                  [ "$FILE_SIZE" -ge 100 ] || log_error "File filter qu√° nh·ªè!"

                  required_headers=("! Title:" "! Version:" "! Last modified:" "! Homepage:" "! License:")
                  for header in "${required_headers[@]}"; do
                    grep -q "^$header" "${{ env.FILTER_FILE }}" || log_error "Thi·∫øu header b·∫Øt bu·ªôc: $header"
                  done

                  RULE_COUNT=$(grep -c "^[^!]" "${{ env.FILTER_FILE }}" || true)
                  [ "$RULE_COUNT" -ge "${{ env.MIN_RULES }}" ] || log_error "Kh√¥ng ƒë·ªß rules (t·ªëi thi·ªÉu: ${{ env.MIN_RULES }})!"
                  echo "RULE_COUNT=$RULE_COUNT" >> $GITHUB_ENV

                  SYNTAX_ERRORS=$(grep -n "^[^!#@|]*[^a-zA-Z0-9.*?^$@#|=/,&_-]" "${{ env.FILTER_FILE }}" || true)
                  if [ -n "$SYNTAX_ERRORS" ]; then
                    echo "::warning::Ph√°t hi·ªán l·ªói c√∫ ph√°p ti·ªÅm ·∫©n:"
                    echo "$SYNTAX_ERRORS"
                  fi

            - name: Update filter metadata
              id: update
              run: |
                  temp_file=$(mktemp)
                  cp "${{ env.FILTER_FILE }}" "${FILTER_FILE}.bak"

                  sed -E "s/^! Version:.*/! Version: ${{ env.FULL_VERSION }}/;\
                         s/^! Last modified:.*/! Last modified: ${{ env.DATE }} ${{ env.TIME }}/;\
                         s/^! Updated by:.*/! Updated by: GitHub Actions/" \
                  "${{ env.FILTER_FILE }}" > "$temp_file"

                  CHECKSUM=$(sha256sum "$temp_file" | cut -d' ' -f1)
                  sed "s/^! Checksum:.*/! Checksum: $CHECKSUM/" "$temp_file" > "${{ env.FILTER_FILE }}"

                  {
                    echo "NETWORK_RULES=$(grep -c "^||" "${{ env.FILTER_FILE }}" || true)"
                    echo "COSMETIC_RULES=$(grep -c "##" "${{ env.FILTER_FILE }}" || true)"
                    echo "WHITELIST_RULES=$(grep -c "^@@" "${{ env.FILTER_FILE }}" || true)"
                    echo "IMPORTANT_RULES=$(grep -c "important" "${{ env.FILTER_FILE }}" || true)"
                    echo "REDIRECT_RULES=$(grep -c "redirect=" "${{ env.FILTER_FILE }}" || true)"
                  } >> $GITHUB_ENV

                  if [[ "${{ github.event.inputs.force_update }}" == "true" ]] || ! git diff --quiet "${{ env.FILTER_FILE }}"; then
                    echo "CHANGED=true" >> $GITHUB_ENV
                  else
                    echo "CHANGED=false" >> $GITHUB_ENV
                  fi

                  rm "$temp_file"

            - name: Generate badges and HTML
              if: env.CHANGED == 'true'
              run: |
                  mkdir -p .github/badges

                  generate_badge() {
                    local label=$1 message=$2 color=$3 style=${4:-flat-square}
                    local filename=".github/badges/${label// /_}.json"
                    echo "{ \"schemaVersion\": 1, \"label\": \"$label\", \"message\": \"$message\", \"color\": \"$color\", \"style\": \"$style\" }" > "$filename"
                  }

                  generate_badge "version" "${{ env.FULL_VERSION }}" "blue"
                  generate_badge "rules" "${{ env.RULE_COUNT }}" "brightgreen"
                  generate_badge "updated" "${{ env.DATE }}" "success"
                  generate_badge "network rules" "${{ env.NETWORK_RULES }}" "informational"
                  generate_badge "cosmetic rules" "${{ env.COSMETIC_RULES }}" "yellow"
                  generate_badge "whitelist rules" "${{ env.WHITELIST_RULES }}" "orange"
                  generate_badge "important rules" "${{ env.IMPORTANT_RULES }}" "red"
                  generate_badge "redirect rules" "${{ env.REDIRECT_RULES }}" "purple"
                  generate_badge "removed duplicates" "${{ env.REMOVED_DUPLICATES }}" "red"
                  generate_badge "ublock" "C√†i ƒë·∫∑t cho uBlock Origin" "1a73e8" "for-the-badge"
                  generate_badge "adguard" "C√†i ƒë·∫∑t cho AdGuard" "67b279" "for-the-badge"

                  cat > index.html << 'EOF'
                  <!DOCTYPE html>
                  <html lang="vi">
                  <head>
                      <meta charset="UTF-8">
                      <meta name="viewport" content="width=device-width, initial-scale=1.0">
                      <title>Yuusei Filter List - B·ªô l·ªçc qu·∫£ng c√°o</title>
                      <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
                      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                  </head>
                  <body class="bg-gray-100 dark:bg-gray-900">
                      <div class="container mx-auto px-4 py-8">
                          <header class="text-center mb-12">
                              <h1 class="text-5xl font-bold text-gray-800 dark:text-white mb-4">üõ°Ô∏è Yuusei Filter List</h1>
                              <p class="text-xl text-gray-600 dark:text-gray-300">B·ªô l·ªçc qu·∫£ng c√°o</p>
                              
                              <div class="flex justify-center space-x-4 mt-8">
                                  <a href="https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/Yuusei.txt" 
                                     class="bg-gradient-to-r from-blue-500 to-blue-700 text-white px-8 py-3 rounded-lg hover:from-blue-600 hover:to-blue-800 transition transform hover:scale-105">
                                     <i class="fas fa-shield-alt mr-2"></i>C√†i ƒë·∫∑t cho uBlock Origin
                                  </a>
                                  <a href="https://subscribe.adblockplus.org/?location=https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/Yuusei.txt"
                                     class="bg-gradient-to-r from-green-500 to-green-700 text-white px-8 py-3 rounded-lg hover:from-green-600 hover:to-green-800 transition transform hover:scale-105">
                                     <i class="fas fa-check-circle mr-2"></i>C√†i ƒë·∫∑t cho AdGuard
                                  </a>
                              </div>
                          </header>

                          <section class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 mb-12 transform hover:scale-[1.02] transition-transform">
                              <h2 class="text-3xl font-bold mb-8 text-gray-800 dark:text-white"><i class="fas fa-chart-bar mr-3"></i>Th·ªëng k√™ chi ti·∫øt</h2>
                              <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                                  <div class="p-6 bg-blue-50 dark:bg-blue-900 rounded-xl">
                                      <h3 class="font-bold text-blue-800 dark:text-blue-200">T·ªïng s·ªë Rules</h3>
                                      <p class="text-3xl font-bold text-blue-600 dark:text-blue-300">${{ env.RULE_COUNT }}</p>
                                  </div>
                                  <div class="p-6 bg-green-50 dark:bg-green-900 rounded-xl">
                                      <h3 class="font-bold text-green-800 dark:text-green-200">Rules m·∫°ng</h3>
                                      <p class="text-3xl font-bold text-green-600 dark:text-green-300">${{ env.NETWORK_RULES }}</p>
                                  </div>
                                  <div class="p-6 bg-yellow-50 dark:bg-yellow-900 rounded-xl">
                                      <h3 class="font-bold text-yellow-800 dark:text-yellow-200">Rules giao di·ªán</h3>
                                      <p class="text-3xl font-bold text-yellow-600 dark:text-yellow-300">${{ env.COSMETIC_RULES }}</p>
                                  </div>
                              </div>
                          </section>

                          <section class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 mb-12">
                              <h2 class="text-3xl font-bold mb-8 text-gray-800 dark:text-white"><i class="fas fa-users mr-3"></i>Ng∆∞·ªùi ƒë√≥ng g√≥p</h2>
                              <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                                  ${contributors_html}
                              </div>
                          </section>

                          <section class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-8 mb-12">
                              <h2 class="text-3xl font-bold mb-8 text-gray-800 dark:text-white"><i class="fas fa-shield-alt mr-3"></i>T√≠nh nƒÉng ch√≠nh</h2>
                              <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                  <div class="p-6 bg-gray-50 dark:bg-gray-700 rounded-xl">
                                      <h3 class="text-2xl font-bold mb-4 text-red-600 dark:text-red-400"><i class="fas fa-ban mr-2"></i>Ch·∫∑n qu·∫£ng c√°o to√†n di·ªán</h3>
                                      <ul class="list-none space-y-3">
                                          <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i>Ch·∫∑n ho√†n to√†n qu·∫£ng c√°o tr√™n c√°c trang web</li>
                                          <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i>Lo·∫°i b·ªè n·ªôi dung ƒë∆∞·ª£c t√†i tr·ª£ v√† qu·∫£ng c√°o</li>
                                          <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i>B·∫£o v·ªá kh·ªèi pop-up v√† overlay</li>
                                      </ul>
                                  </div>
                                  <div class="p-6 bg-gray-50 dark:bg-gray-700 rounded-xl">
                                      <h3 class="text-2xl font-bold mb-4 text-blue-600 dark:text-blue-400"><i class="fas fa-lock mr-2"></i>B·∫£o v·ªá quy·ªÅn ri√™ng t∆∞</h3>
                                      <ul class="list-none space-y-3">
                                          <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i>Ch·∫∑n script v√† pixel theo d√µi</li>
                                          <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i>NgƒÉn ch·∫∑n browser fingerprinting</li>
                                          <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i>B·∫£o v·ªá kh·ªèi malware v√† phishing</li>
                                      </ul>
                                  </div>
                              </div>
                          </section>

                          <footer class="text-center text-gray-600 dark:text-gray-400">
                              <p class="text-lg">ƒê∆∞·ª£c t·∫°o v·ªõi <i class="fas fa-heart text-red-500"></i> b·ªüi Yuusei</p>
                              <p class="mt-2">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: ${{ env.DATE }} ${{ env.TIME }} (${{ env.TIMEZONE }})</p>
                              <div class="mt-4 flex justify-center space-x-4">
                                  <a href="https://github.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                      <i class="fab fa-github text-2xl"></i>
                                  </a>
                              </div>
                          </footer>
                      </div>
                      <script>
                          // Ki·ªÉm tra dark mode
                          if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                              document.documentElement.classList.add('dark');
                          }
                      </script>
                  </body>
                  </html>
                  EOF

                  # Thay th·∫ø placeholder cho contributors
                  contributors_html=""
                  while IFS= read -r contributor; do
                      login=$(echo "$contributor" | jq -r '.login')
                      avatar_url=$(echo "$contributor" | jq -r '.avatar_url')
                      contributions=$(echo "$contributor" | jq -r '.contributions')
                      html_url=$(echo "$contributor" | jq -r '.html_url')
                      
                      contributors_html+="<div class='text-center p-4 bg-gray-50 dark:bg-gray-700 rounded-lg'>
                          <img src='$avatar_url' alt='$login' class='w-20 h-20 rounded-full mx-auto mb-3'>
                          <a href='$html_url' class='font-bold text-blue-600 dark:text-blue-400 hover:underline'>$login</a>
                          <p class='text-sm text-gray-600 dark:text-gray-400'>$contributions ƒë√≥ng g√≥p</p>
                      </div>"
                  done < <(echo "${{ env.CONTRIBUTORS }}" | jq -c '.[]')

                  sed -i "s|\${contributors_html}|$contributors_html|" index.html

            - name: Commit changes
              if: env.CHANGED == 'true'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  git add "${{ env.FILTER_FILE }}" index.html .github/badges || true
                  git commit -m "üîÑ C·∫≠p nh·∫≠t t·ª± ƒë·ªông (Phi√™n b·∫£n: ${{ env.FULL_VERSION }}, ƒê√£ x√≥a ${{ env.REMOVED_DUPLICATES }} rules tr√πng l·∫∑p)"
                  git push
