name: Update Yuusei Filter

on:
    push:
        paths:
            - 'Yuusei.txt'
    schedule:
        - cron: '0 0 * * *' # Ch·∫°y h√†ng ng√†y l√∫c 00:00 UTC
    workflow_dispatch:
        inputs:
            force_update:
                description: 'C·∫≠p nh·∫≠t b·∫Øt bu·ªôc ngay c·∫£ khi kh√¥ng c√≥ thay ƒë·ªïi'
                required: false
                type: boolean
                default: false

env:
    FILTER_FILE: Yuusei.txt
    MIN_RULES: 10
    TIMEZONE: 'Asia/Ho_Chi_Minh'
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    OUTPUT_DIR: .github/badges
    BACKUP_DIR: .github/backup

jobs:
    update-filter:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup environment
              id: setup
              run: |
                  # T·∫°o th∆∞ m·ª•c output v√† backup n·∫øu ch∆∞a t·ªìn t·∫°i
                  mkdir -p ${{ env.OUTPUT_DIR }} ${{ env.BACKUP_DIR }}

                  # C√†i ƒë·∫∑t m√∫i gi·ªù
                  sudo ln -sf /usr/share/zoneinfo/${{ env.TIMEZONE }} /etc/localtime

                  # Thi·∫øt l·∫≠p c√°c bi·∫øn m√¥i tr∆∞·ªùng
                  {
                    echo "DATE=$(date +'%d-%m-%Y')"
                    echo "TIME=$(date +'%H:%M:%S')"
                    echo "YEAR=$(date +'%Y')"
                    echo "REPO_NAME=${GITHUB_REPOSITORY#*/}"
                    echo "AUTHOR_NAME=${GITHUB_REPOSITORY%/*}"
                    echo "TIMESTAMP=$(date +%s)"
                  } >> $GITHUB_ENV

                  # Sao l∆∞u file g·ªëc
                  cp "${{ env.FILTER_FILE }}" "${{ env.BACKUP_DIR }}/${FILTER_FILE}_$(date +%Y%m%d_%H%M%S).bak"

            - name: Remove duplicate rules
              id: deduplicate
              run: |
                  # T·∫°o file t·∫°m ƒë·ªÉ l∆∞u rules kh√¥ng tr√πng l·∫∑p
                  temp_file=$(mktemp)

                  # Ph√¢n lo·∫°i v√† x·ª≠ l√Ω rules
                  {
                    # Gi·ªØ l·∫°i header v√† comment
                    grep "^[!#]" "${{ env.FILTER_FILE }}"
                    
                    # X·ª≠ l√Ω v√† s·∫Øp x·∫øp c√°c rules kh√¥ng tr√πng l·∫∑p
                    grep -v "^[!#]" "${{ env.FILTER_FILE }}" | \
                    sort -u | \
                    # Lo·∫°i b·ªè kho·∫£ng tr·∫Øng th·ª´a
                    sed 's/^[ \t]*//;s/[ \t]*$//'
                  } > "$temp_file"

                  # T√≠nh to√°n s·ªë l∆∞·ª£ng rules ƒë√£ x√≥a
                  original_count=$(grep -cv "^[!#]" "${{ env.FILTER_FILE }}")
                  new_count=$(grep -cv "^[!#]" "$temp_file")
                  removed_count=$((original_count - new_count))

                  # Ghi log
                  echo "ƒê√£ x√≥a $removed_count rules tr√πng l·∫∑p"
                  echo "REMOVED_DUPLICATES=$removed_count" >> $GITHUB_ENV

                  # C·∫≠p nh·∫≠t file g·ªëc
                  mv "$temp_file" "${{ env.FILTER_FILE }}"

            - name: Validate filter file
              id: validate
              run: |
                  # H√†m ki·ªÉm tra v√† ghi log
                  validate_and_log() {
                    local check_name=$1
                    local check_command=$2
                    local error_message=$3
                    
                    if ! eval "$check_command"; then
                      echo "::error::[$check_name] $error_message"
                      return 1
                    fi
                    echo "::debug::[$check_name] Ki·ªÉm tra th√†nh c√¥ng"
                    return 0
                  }

                  # Ki·ªÉm tra t·∫•t c·∫£ ƒëi·ªÅu ki·ªán
                  validate_and_log "File exists" \
                    "[ -f '${{ env.FILTER_FILE }}' ]" \
                    "Kh√¥ng t√¨m th·∫•y file filter!"

                  validate_and_log "File size" \
                    "[ $(stat -f%z '${{ env.FILTER_FILE }}' 2>/dev/null || stat -c%s '${{ env.FILTER_FILE }}') -ge 100 ]" \
                    "File filter qu√° nh·ªè!"

                  # Ki·ªÉm tra headers
                  required_headers=("! Title:" "! Version:" "! Last modified:")
                  for header in "${required_headers[@]}"; do
                    validate_and_log "Header $header" \
                      "grep -q '^$header' '${{ env.FILTER_FILE }}'" \
                      "Thi·∫øu header b·∫Øt bu·ªôc: $header"
                  done

                  # ƒê·∫øm v√† ki·ªÉm tra s·ªë l∆∞·ª£ng rules
                  RULE_COUNT=$(grep -c "^[^!#]" "${{ env.FILTER_FILE }}" || true)
                  validate_and_log "Rule count" \
                    "[ $RULE_COUNT -ge ${{ env.MIN_RULES }} ]" \
                    "Kh√¥ng ƒë·ªß rules (t·ªëi thi·ªÉu: ${{ env.MIN_RULES }})!"

                  echo "RULE_COUNT=$RULE_COUNT" >> $GITHUB_ENV

                  # Ki·ªÉm tra c√∫ ph√°p
                  SYNTAX_ERRORS=$(grep -n "^[^!#@|]*[^a-zA-Z0-9.*?^$@#|=/,&_-]" "${{ env.FILTER_FILE }}" || true)
                  if [ -n "$SYNTAX_ERRORS" ]; then
                    echo "::warning::Ph√°t hi·ªán l·ªói c√∫ ph√°p ti·ªÅm ·∫©n:"
                    echo "$SYNTAX_ERRORS"
                  fi

            - name: Update filter metadata
              id: update
              run: |
                  # T·∫°o file t·∫°m
                  temp_file=$(mktemp)

                  # C·∫≠p nh·∫≠t metadata v·ªõi sed
                  sed -E "
                    s/^! Version:.*/! Version: ${{ env.DATE }}/
                    s/^! Last modified:.*/! Last modified: ${{ env.DATE }} ${{ env.TIME }}/
                    s/^! Updated by:.*/! Updated by: GitHub Actions/
                    s/^! Timestamp:.*/! Timestamp: ${{ env.TIMESTAMP }}/
                  " "${{ env.FILTER_FILE }}" > "$temp_file"

                  # T√≠nh to√°n v√† th√™m checksum
                  CHECKSUM=$(sha256sum "$temp_file" | cut -d' ' -f1)
                  sed "s/^! Checksum:.*/! Checksum: $CHECKSUM/" "$temp_file" > "${{ env.FILTER_FILE }}"

                  # Ph√¢n t√≠ch v√† ƒë·∫øm c√°c lo·∫°i rules
                  {
                    echo "NETWORK_RULES=$(grep -c "^||" "${{ env.FILTER_FILE }}" || true)"
                    echo "COSMETIC_RULES=$(grep -c "##" "${{ env.FILTER_FILE }}" || true)"
                    echo "WHITELIST_RULES=$(grep -c "^@@" "${{ env.FILTER_FILE }}" || true)"
                    echo "CHECKSUM=$CHECKSUM"
                  } >> $GITHUB_ENV

                  # Ki·ªÉm tra thay ƒë·ªïi
                  if [[ "${{ github.event.inputs.force_update }}" == "true" ]] || ! git diff --quiet "${{ env.FILTER_FILE }}"; then
                    echo "CHANGED=true" >> $GITHUB_ENV
                  else
                    echo "CHANGED=false" >> $GITHUB_ENV
                  fi

                  rm "$temp_file"

            - name: Generate badges and README
              if: env.CHANGED == 'true'
              run: |
                  # H√†m t·∫°o badges v·ªõi cache busting
                  generate_badge() {
                    local label=$1 message=$2 color=$3 style=${4:-flat-square}
                    local filename="${{ env.OUTPUT_DIR }}/${label// /_}.json"
                    local cache_buster=$(date +%s)
                    echo "{
                      \"schemaVersion\": 1,
                      \"label\": \"$label\",
                      \"message\": \"$message\",
                      \"color\": \"$color\",
                      \"style\": \"$style\",
                      \"cacheSeconds\": 300,
                      \"isError\": false,
                      \"timestamp\": \"$cache_buster\"
                    }" > "$filename"
                  }

                  # T·∫°o t·∫•t c·∫£ badges v·ªõi th√¥ng tin c·∫≠p nh·∫≠t
                  generate_badge "version" "${{ env.DATE }}" "blue"
                  generate_badge "rules" "${{ env.RULE_COUNT }}" "brightgreen"
                  generate_badge "updated" "${{ env.DATE }}" "success"
                  generate_badge "network rules" "${{ env.NETWORK_RULES }}" "informational"
                  generate_badge "cosmetic rules" "${{ env.COSMETIC_RULES }}" "yellow"
                  generate_badge "whitelist rules" "${{ env.WHITELIST_RULES }}" "orange"
                  generate_badge "removed duplicates" "${{ env.REMOVED_DUPLICATES }}" "red"
                  generate_badge "ublock" "C√†i ƒë·∫∑t cho uBlock Origin" "1a73e8" "for-the-badge"
                  generate_badge "adguard" "C√†i ƒë·∫∑t cho AdGuard" "67b279" "for-the-badge"

                  # T·∫°o README v·ªõi th√¥ng tin m·ªõi nh·∫•t
                  cat > README.md << 'EOF'
                  <div align="center">

                  # üõ°Ô∏è Yuusei Filter List

                  _B·ªô l·ªçc qu·∫£ng c√°o n√¢ng cao v·ªõi c·∫≠p nh·∫≠t t·ª± ƒë·ªông h√†ng ng√†y_

                  [![Version](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/.github/badges/version.json)](https://github.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/Yuusei.txt)
                  [![Rules](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/.github/badges/rules.json)](https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/Yuusei.txt)
                  [![Updated](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/.github/badges/updated.json)](https://github.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/commits/main)
                  [![Removed Duplicates](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/.github/badges/removed_duplicates.json)](https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/Yuusei.txt)
                  [![License](https://img.shields.io/badge/license-GPL--3.0-orange?style=flat-square)](LICENSE)
                  [![Stars](https://img.shields.io/github/stars/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}?style=flat-square&color=yellow)](https://github.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/stargazers)

                  </div>

                  ## üì¶ C√†i ƒë·∫∑t nhanh

                  <div align="center">

                  [![Install for uBlock Origin](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/.github/badges/ublock.json)](https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/Yuusei.txt)
                  [![Install for AdGuard](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/.github/badges/adguard.json)](https://subscribe.adblockplus.org/?location=https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/Yuusei.txt)

                  </div>

                  ### üîó URL b·ªô l·ªçc
                  ```
                  https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/Yuusei.txt
                  ```

                  ## üìä Th·ªëng k√™

                  <div align="center">

                  | Danh m·ª•c | S·ªë l∆∞·ª£ng | Tr·∫°ng th√°i |
                  |----------|--------|---------|
                  | T·ªïng s·ªë Rules | ${{ env.RULE_COUNT }} | ![Rules](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/.github/badges/rules.json) |
                  | Rules m·∫°ng | ${{ env.NETWORK_RULES }} | ![Network](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/.github/badges/network_rules.json) |
                  | Rules giao di·ªán | ${{ env.COSMETIC_RULES }} | ![Cosmetic](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/.github/badges/cosmetic_rules.json) |
                  | Rules whitelist | ${{ env.WHITELIST_RULES }} | ![Whitelist](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/.github/badges/whitelist_rules.json) |
                  | Rules tr√πng ƒë√£ x√≥a | ${{ env.REMOVED_DUPLICATES }} | ![Removed Duplicates](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/.github/badges/removed_duplicates.json) |

                  </div>

                  ## üõ°Ô∏è T√≠nh nƒÉng

                  ### üö´ Ch·∫∑n qu·∫£ng c√°o
                  - Ch·∫∑n ho√†n to√†n qu·∫£ng c√°o tr√™n c√°c trang web
                  - Lo·∫°i b·ªè n·ªôi dung ƒë∆∞·ª£c t√†i tr·ª£ v√† qu·∫£ng c√°o
                  - B·∫£o v·ªá kh·ªèi pop-up v√† overlay
                  - V∆∞·ª£t qua ch·ªëng ch·∫∑n qu·∫£ng c√°o

                  ### üîí B·∫£o v·ªá quy·ªÅn ri√™ng t∆∞
                  - Ch·∫∑n script v√† pixel theo d√µi
                  - NgƒÉn ch·∫∑n browser fingerprinting
                  - B·∫£o v·ªá kh·ªèi theo d√µi analytics
                  - Tr·∫£i nghi·ªám duy·ªát web an to√†n

                  ### ‚ö° T·ªëi ∆∞u hi·ªáu su·∫•t
                  - TƒÉng t·ªëc ƒë·ªô t·∫£i trang
                  - Gi·∫£m s·ª≠ d·ª•ng bƒÉng th√¥ng
                  - Tr·∫£i nghi·ªám duy·ªát web s·∫°ch s·∫Ω
                  - T·ªëi ∆∞u s·ª≠ d·ª•ng b·ªô nh·ªõ

                  ### üîÑ B·∫£o tr√¨
                  - C·∫≠p nh·∫≠t t·ª± ƒë·ªông h√†ng ng√†y
                  - Ki·ªÉm so√°t ch·∫•t l∆∞·ª£ng nghi√™m ng·∫∑t
                  - Gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ nhanh ch√≥ng
                  - T·ªëi ∆∞u h√≥a th∆∞·ªùng xuy√™n

                  ## ü§ù ƒê√≥ng g√≥p

                  <div align="center">

                  [![Report Bug](https://img.shields.io/badge/B√°o%20l·ªói-G·ª≠i%20Issue-red?style=for-the-badge)](https://github.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/issues/new?assignees=&labels=bug&template=bug_report.md)
                  [![Request Feature](https://img.shields.io/badge/Y√™u%20c·∫ßu%20t√≠nh%20nƒÉng-G·ª≠i%20√Ω%20t∆∞·ªüng-blue?style=for-the-badge)](https://github.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/issues/new?assignees=&labels=enhancement&template=feature_request.md)

                  </div>

                  ## üìú Gi·∫•y ph√©p

                  D·ª± √°n n√†y ƒë∆∞·ª£c c·∫•p ph√©p theo [GNU GPL v3.0](LICENSE)

                  ## ‚≠ê H·ªó tr·ª£

                  N·∫øu b·∫°n th·∫•y d·ª± √°n n√†y h·ªØu √≠ch:
                  - Star repository ‚≠ê
                  - Chia s·∫ª v·ªõi m·ªçi ng∆∞·ªùi üîÑ
                  - B√°o c√°o l·ªói üêõ
                  - ƒê√≥ng g√≥p c·∫£i ti·∫øn üõ†Ô∏è

                  ---

                  <div align="center">

                  ƒê∆∞·ª£c t·∫°o v·ªõi ‚ù§Ô∏è b·ªüi [Yuusei](https://github.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}) | ¬© ${{ env.YEAR }}

                  <sub>C·∫≠p nh·∫≠t t·ª± ƒë·ªông b·ªüi GitHub Actions</sub>

                  _C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: ${{ env.DATE }} ${{ env.TIME }} (${{ env.TIMEZONE }})_

                  </div>
                  EOF

            - name: Commit changes
              if: env.CHANGED == 'true'
              run: |
                  # C·∫•u h√¨nh git
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

                  # Th√™m c√°c file ƒë√£ thay ƒë·ªïi
                  git add "${{ env.FILTER_FILE }}" README.md "${{ env.OUTPUT_DIR }}" || true

                  # T·∫°o commit message v·ªõi th√¥ng tin chi ti·∫øt
                  commit_message="üîÑ C·∫≠p nh·∫≠t t·ª± ƒë·ªông

                  Phi√™n b·∫£n: ${{ env.DATE }}
                  Checksum: ${{ env.CHECKSUM }}
                  Rules: ${{ env.RULE_COUNT }}
                  ƒê√£ x√≥a: ${{ env.REMOVED_DUPLICATES }} rules tr√πng l·∫∑p

                  Network rules: ${{ env.NETWORK_RULES }}
                  Cosmetic rules: ${{ env.COSMETIC_RULES }}
                  Whitelist rules: ${{ env.WHITELIST_RULES }}"

                  # Commit v√† push
                  git commit -m "$commit_message"
                  git push
