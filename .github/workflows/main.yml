name: Update Yuusei Filter

on:
    push:
        paths:
            - 'Yuusei.txt'
    schedule:
        - cron: '0 0,12 * * *'
    workflow_dispatch:
        inputs:
            force_update:
                description: 'Cập nhật bắt buộc ngay cả khi không có thay đổi'
                required: false
                type: boolean
                default: false

env:
    FILTER_FILE: Yuusei.txt
    MIN_RULES: 10
    TIMEZONE: 'Asia/Ho_Chi_Minh'
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
    update-filter:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup environment
              id: setup
              run: |
                  sudo ln -sf /usr/share/zoneinfo/${{ env.TIMEZONE }} /etc/localtime
                  {
                    echo "DATE=$(date +'%d-%m-%Y')"
                    echo "TIME=$(date +'%H:%M:%S')"
                    echo "YEAR=$(date +'%Y')"
                    echo "REPO_NAME=${GITHUB_REPOSITORY#*/}"
                    echo "AUTHOR_NAME=${GITHUB_REPOSITORY%/*}"
                    echo "FULL_VERSION=$(date +'%Y.%m.%d')"
                  } >> $GITHUB_ENV

            - name: Get contributors info
              id: contributors
              run: |
                  contributors=$(gh api repos/${{ github.repository }}/contributors --jq '[.[] | {login: .login, avatar_url: .avatar_url, contributions: .contributions, html_url: .html_url}]')
                  echo "CONTRIBUTORS=$contributors" >> $GITHUB_OUTPUT
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Validate and sort filter file
              id: validate
              run: |
                  log_error() {
                    echo "::error::$1"
                    exit 1
                  }

                  [ -f "${{ env.FILTER_FILE }}" ] || log_error "Không tìm thấy file filter!"
                  FILE_SIZE=$(stat -f%z "${{ env.FILTER_FILE }}" 2>/dev/null || stat -c%s "${{ env.FILTER_FILE }}")
                  [ "$FILE_SIZE" -ge 100 ] || log_error "File filter quá nhỏ!"

                  required_headers=("! Title:" "! Version:" "! Last modified:" "! Homepage:" "! License:")
                  for header in "${required_headers[@]}"; do
                    grep -q "^$header" "${{ env.FILTER_FILE }}" || log_error "Thiếu header bắt buộc: $header"
                  done

                  # Extract headers and rules separately
                  headers=$(grep "^!" "${{ env.FILTER_FILE }}")
                  rules=$(grep -v "^!" "${{ env.FILTER_FILE }}" | sort -f | uniq)

                  # Combine headers and sorted rules
                  {
                    echo "$headers"
                    echo "$rules"
                  } > "${{ env.FILTER_FILE }}"

                  RULE_COUNT=$(echo "$rules" | wc -l)
                  [ "$RULE_COUNT" -ge "${{ env.MIN_RULES }}" ] || log_error "Không đủ rules (tối thiểu: ${{ env.MIN_RULES }})!"
                  echo "RULE_COUNT=$RULE_COUNT" >> $GITHUB_ENV

                  SYNTAX_ERRORS=$(echo "$rules" | grep -n "[^a-zA-Z0-9.*?^$@#|=/,&_-]" || true)
                  if [ -n "$SYNTAX_ERRORS" ]; then
                    echo "::warning::Phát hiện lỗi cú pháp tiềm ẩn:"
                    echo "$SYNTAX_ERRORS"
                  fi

            - name: Update filter metadata
              id: update
              run: |
                  temp_file=$(mktemp)
                  cp "${{ env.FILTER_FILE }}" "${FILTER_FILE}.bak"

                  sed -E "s/^! Version:.*/! Version: ${{ env.FULL_VERSION }}/;\
                         s/^! Last modified:.*/! Last modified: ${{ env.DATE }} ${{ env.TIME }}/;\
                         s/^! Updated by:.*/! Updated by: GitHub Actions/" \
                  "${{ env.FILTER_FILE }}" > "$temp_file"

                  CHECKSUM=$(sha256sum "$temp_file" | cut -d' ' -f1)
                  sed "s/^! Checksum:.*/! Checksum: $CHECKSUM/" "$temp_file" > "${{ env.FILTER_FILE }}"

                  {
                    echo "NETWORK_RULES=$(grep -c "^||" "${{ env.FILTER_FILE }}" || true)"
                    echo "COSMETIC_RULES=$(grep -c "##" "${{ env.FILTER_FILE }}" || true)"
                    echo "WHITELIST_RULES=$(grep -c "^@@" "${{ env.FILTER_FILE }}" || true)"
                  } >> $GITHUB_ENV

                  if [[ "${{ github.event.inputs.force_update }}" == "true" ]] || ! git diff --quiet "${{ env.FILTER_FILE }}"; then
                    echo "CHANGED=true" >> $GITHUB_ENV
                  else
                    echo "CHANGED=false" >> $GITHUB_ENV
                  fi

                  rm "$temp_file"

            - name: Generate badges and HTML
              if: env.CHANGED == 'true'
              run: |
                  mkdir -p .github/badges

                  generate_badge() {
                    local label=$1 message=$2 color=$3
                    local filename=".github/badges/${label// /_}.json"
                    echo "{ \"schemaVersion\": 1, \"label\": \"$label\", \"message\": \"$message\", \"color\": \"$color\", \"style\": \"flat-square\" }" > "$filename"
                  }

                  generate_badge "version" "${{ env.FULL_VERSION }}" "blue"
                  generate_badge "rules" "${{ env.RULE_COUNT }}" "brightgreen"
                  generate_badge "updated" "${{ env.DATE }}" "success"

                  cat > index.html << 'EOF'
                  <!DOCTYPE html>
                  <html lang="vi">
                  <head>
                      <meta charset="UTF-8">
                      <meta name="viewport" content="width=device-width, initial-scale=1.0">
                      <meta name="description" content="Yuusei Filter List - Bộ lọc quảng cáo hiệu quả cho người Việt">
                      <meta name="keywords" content="adblock, filter list, ublock origin, adguard, quảng cáo, việt nam">
                      <meta name="author" content="RenjiYuusei">
                      <meta property="og:title" content="Yuusei Filter List - Bộ lọc quảng cáo Việt Nam">
                      <meta property="og:description" content="Bảo vệ trải nghiệm web của bạn khỏi quảng cáo không mong muốn">
                      <meta property="og:image" content="https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/.github/assets/logo.png">
                      <meta property="og:url" content="https://${{ env.AUTHOR_NAME }}.github.io/${{ env.REPO_NAME }}">
                      <title>Yuusei Filter List - Bộ lọc quảng cáo Việt Nam</title>
                      <link rel="icon" type="image/png" href=".github/assets/favicon.png">
                      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.16/base.min.css">
                      <script src="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.16/lib/index.min.js"></script>
                      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
                      <link rel="preconnect" href="https://fonts.googleapis.com">
                      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                      <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
                      <style>
                          :root {
                              --primary-color: #1a73e8;
                              --hover-color: #1557b0;
                          }
                          body {
                              font-family: 'Be Vietnam Pro', sans-serif;
                          }
                          .theme-toggle {
                              position: fixed;
                              top: 1rem;
                              right: 1rem;
                              padding: 0.75rem;
                              border-radius: 50%;
                              background: var(--primary-color);
                              color: white;
                              cursor: pointer;
                              z-index: 1000;
                              transition: all 0.3s ease;
                              box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                          }
                          .theme-toggle:hover {
                              background: var(--hover-color);
                              transform: scale(1.1);
                          }
                          .card {
                              transition: all 0.3s ease;
                              border: 1px solid rgba(0,0,0,0.1);
                              backdrop-filter: blur(10px);
                          }
                          .card:hover {
                              transform: translateY(-5px);
                              box-shadow: 0 8px 16px rgba(0,0,0,0.1);
                          }
                          .copy-link {
                              cursor: pointer;
                              padding: 0.75rem 1.5rem;
                              background: #f0f0f0;
                              border-radius: 0.5rem;
                              display: inline-flex;
                              align-items: center;
                              gap: 0.75rem;
                              transition: all 0.3s ease;
                              font-weight: 500;
                          }
                          .dark .copy-link {
                              background: #2d3748;
                          }
                          .copy-link:hover {
                              transform: translateY(-2px);
                              box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                          }
                          .contributor-card {
                              transition: all 0.3s ease;
                              backdrop-filter: blur(10px);
                          }
                          .contributor-card:hover {
                              transform: translateY(-3px);
                          }
                          .btn-primary {
                              transition: all 0.3s ease;
                              position: relative;
                              overflow: hidden;
                          }
                          .btn-primary:hover {
                              transform: translateY(-2px);
                          }
                          .btn-primary::after {
                              content: '';
                              position: absolute;
                              top: 50%;
                              left: 50%;
                              width: 0;
                              height: 0;
                              background: rgba(255,255,255,0.2);
                              border-radius: 50%;
                              transform: translate(-50%, -50%);
                              transition: width 0.6s, height 0.6s;
                          }
                          .btn-primary:active::after {
                              width: 200px;
                              height: 200px;
                          }
                          @keyframes fadeIn {
                              from { opacity: 0; transform: translateY(20px); }
                              to { opacity: 1; transform: translateY(0); }
                          }
                          .animate-fade-in {
                              animation: fadeIn 1s ease-out;
                          }
                          .glass-effect {
                              background: rgba(255, 255, 255, 0.1);
                              backdrop-filter: blur(10px);
                              border: 1px solid rgba(255, 255, 255, 0.2);
                          }
                          .dark .glass-effect {
                              background: rgba(0, 0, 0, 0.2);
                              border: 1px solid rgba(255, 255, 255, 0.1);
                          }
                      </style>
                  </head>
                  <body class="bg-gradient-to-br from-gray-100 via-blue-50 to-gray-200 dark:from-gray-900 dark:via-blue-900 dark:to-gray-800 min-h-screen transition-colors duration-300">
                      <div class="fixed inset-0 bg-gradient-to-br from-blue-100/50 to-purple-100/50 dark:from-blue-900/30 dark:to-purple-900/30 pointer-events-none"></div>
                      
                      <button id="theme-toggle" class="theme-toggle" aria-label="Chuyển đổi giao diện sáng/tối">
                          <i class="fas fa-sun dark:hidden"></i>
                          <i class="fas fa-moon hidden dark:block"></i>
                      </button>

                      <div class="container mx-auto px-4 py-12 relative">
                          <header class="text-center mb-20 animate-fade-in">
                              <h1 class="text-6xl font-bold text-gray-800 dark:text-white mb-8">
                                  🛡️ Yuusei Filter List
                              </h1>
                              <p class="text-2xl text-gray-600 dark:text-gray-300 mb-12">
                                  Bảo vệ trải nghiệm web của bạn khỏi quảng cáo không mong muốn
                              </p>
                              
                              <div class="flex flex-col sm:flex-row justify-center gap-6 mb-12">
                                  <a href="https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/Yuusei.txt" 
                                     class="btn-primary bg-blue-600 text-white px-8 py-4 rounded-xl hover:bg-blue-700 flex items-center justify-center gap-2 shadow-lg">
                                     <i class="fas fa-shield-alt"></i>
                                     <span>Cài đặt cho uBlock Origin</span>
                                  </a>
                                  <a href="https://subscribe.adblockplus.org/?location=https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/Yuusei.txt"
                                     class="btn-primary bg-green-600 text-white px-8 py-4 rounded-xl hover:bg-green-700 flex items-center justify-center gap-2 shadow-lg">
                                     <i class="fas fa-check-circle"></i>
                                     <span>Cài đặt cho AdGuard</span>
                                  </a>
                              </div>

                              <div class="copy-link glass-effect" onclick="copyFilterLink()" role="button" tabindex="0">
                                  <i class="fas fa-copy"></i>
                                  <span>Copy Link Filter List</span>
                              </div>
                          </header>

                          <section class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-20">
                              <div class="card glass-effect rounded-xl p-8 shadow-lg">
                                  <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                                      <i class="fas fa-shield-alt text-blue-500"></i>
                                      <span>Tổng số Rules</span>
                                  </h3>
                                  <p class="text-4xl font-bold text-blue-600 dark:text-blue-400">
                                      ${{ env.RULE_COUNT }}
                                  </p>
                              </div>
                              <div class="card glass-effect rounded-xl p-8 shadow-lg">
                                  <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                                      <i class="fas fa-globe text-green-500"></i>
                                      <span>Rules Mạng</span>
                                  </h3>
                                  <p class="text-4xl font-bold text-green-600 dark:text-green-400">
                                      ${{ env.NETWORK_RULES }}
                                  </p>
                              </div>
                              <div class="card glass-effect rounded-xl p-8 shadow-lg">
                                  <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                                      <i class="fas fa-paint-brush text-yellow-500"></i>
                                      <span>Rules Giao Diện</span>
                                  </h3>
                                  <p class="text-4xl font-bold text-yellow-600 dark:text-yellow-400">
                                      ${{ env.COSMETIC_RULES }}
                                  </p>
                              </div>
                          </section>

                          <section id="contributors" class="glass-effect rounded-xl p-8 shadow-lg mb-16">
                              <h2 class="text-3xl font-bold mb-8 flex items-center gap-3">
                                  <i class="fas fa-users text-purple-500"></i>
                                  <span>Người Đóng Góp</span>
                              </h2>
                              <div class="grid grid-cols-2 md:grid-cols-4 gap-6" id="contributors-container"></div>
                          </section>

                          <footer class="text-center text-gray-600 dark:text-gray-400">
                              <p class="mb-4">
                                  Cập nhật lần cuối: ${{ env.DATE }} ${{ env.TIME }}
                              </p>
                              <div class="flex justify-center gap-4">
                                  <a href="https://github.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}" 
                                     class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
                                     aria-label="GitHub Repository">
                                      <i class="fab fa-github text-2xl"></i>
                                  </a>
                              </div>
                          </footer>
                      </div>

                      <script>
                          // Theme toggle with smooth transition
                          const themeToggle = document.getElementById('theme-toggle');
                          const html = document.documentElement;
                          
                          function setTheme(isDark) {
                              if (isDark) {
                                  html.classList.add('dark');
                              } else {
                                  html.classList.remove('dark');
                              }
                              localStorage.theme = isDark ? 'dark' : 'light';
                          }

                          // Initial theme with system preference detection
                          setTheme(
                              localStorage.theme === 'dark' || 
                              (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
                          );

                          themeToggle.addEventListener('click', () => {
                              setTheme(!html.classList.contains('dark'));
                          });

                          // Enhanced copy link function with better feedback
                          function copyFilterLink() {
                              const filterLink = 'https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/Yuusei.txt';
                              navigator.clipboard.writeText(filterLink).then(() => {
                                  const copyBtn = document.querySelector('.copy-link');
                                  const originalHTML = copyBtn.innerHTML;
                                  copyBtn.innerHTML = '<i class="fas fa-check text-green-500"></i><span>Đã sao chép!</span>';
                                  copyBtn.classList.add('bg-green-100', 'dark:bg-green-900');
                                  
                                  setTimeout(() => {
                                      copyBtn.innerHTML = originalHTML;
                                      copyBtn.classList.remove('bg-green-100', 'dark:bg-green-900');
                                  }, 2000);
                              }).catch(err => {
                                  console.error('Lỗi khi sao chép:', err);
                                  alert('Không thể sao chép link. Vui lòng thử lại.');
                              });
                          }

                          // Enhanced contributors loading with animation
                          try {
                              const contributors = ${{ steps.contributors.outputs.CONTRIBUTORS }};
                              const container = document.getElementById('contributors-container');
                              
                              contributors.forEach((contributor, index) => {
                                  const card = document.createElement('div');
                                  card.className = 'contributor-card glass-effect rounded-xl p-4 text-center';
                                  card.style.animation = `fadeIn 0.5s ease-out ${index * 0.1}s both`;
                                  card.innerHTML = `
                                      <img src="${contributor.avatar_url}" alt="${contributor.login}" 
                                           class="w-20 h-20 rounded-full mx-auto mb-3 border-4 border-white dark:border-gray-600 hover:scale-110 transition-transform"
                                           loading="lazy">
                                      <a href="${contributor.html_url}" 
                                         class="font-bold text-blue-600 dark:text-blue-400 hover:underline block mb-1"
                                         target="_blank" rel="noopener noreferrer">
                                          ${contributor.login}
                                      </a>
                                      <p class="text-sm text-gray-600 dark:text-gray-400">
                                          ${contributor.contributions} đóng góp
                                      </p>
                                  `;
                                  container.appendChild(card);
                              });
                          } catch (error) {
                              console.error('Lỗi khi tải thông tin người đóng góp:', error);
                              document.getElementById('contributors').style.display = 'none';
                          }
                      </script>
                  </body>
                  </html>
                  EOF

            - name: Commit changes
              if: env.CHANGED == 'true'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  git add "${{ env.FILTER_FILE }}" index.html .github/badges || true
                  git commit -m "🔄 Cập nhật tự động (Phiên bản: ${{ env.FULL_VERSION }})"
                  git pull origin main --rebase
                  git push
