name: Update Yuusei Filter & Deploy Site

on:
    push:
        paths:
            - 'Yuusei.txt'
            - 'index.html'
            - '.github/workflows/main.yml'
    workflow_dispatch:
        inputs:
            force_update:
                description: 'Force Update'
                required: false
                type: boolean
                default: false

env:
    FILTER_FILE: Yuusei.txt
    MIN_RULES: 10
    TIMEZONE: 'Asia/Ho_Chi_Minh'
    CACHE_VERSION: 'v1'

# Permissions required for Pages deployment and modifying repo
permissions:
    contents: write
    pages: write
    id-token: write

jobs:
    update-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup environment
              run: |
                  sudo ln -sf /usr/share/zoneinfo/${{ env.TIMEZONE }} /etc/localtime
                  echo "DATE=$(date +'%d-%m-%Y')" >> $GITHUB_ENV
                  echo "FULL_VERSION=$(date +'%Y.%m.%d.%H%M')" >> $GITHUB_ENV
                  echo "REPO_NAME=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV
                  echo "AUTHOR_NAME=${GITHUB_REPOSITORY%/*}" >> $GITHUB_ENV

            - name: Validate and analyze filter file
              id: validate
              run: |
                  if [ ! -f "${{ env.FILTER_FILE }}" ]; then
                    echo "::error::File not found: ${{ env.FILTER_FILE }}"
                    exit 1
                  fi

                  # Basic cleanup
                  sed -i '/^$/d' "${FILTER_FILE}"
                  
                  RULE_COUNT=$(grep -cvE '^!|^$' "${FILTER_FILE}")
                  echo "RULE_COUNT=$RULE_COUNT" >> $GITHUB_ENV

                  # Calculate checksum
                  CHECKSUM=$(sha256sum "${FILTER_FILE}" | cut -d' ' -f1)
                  echo "CHECKSUM=$CHECKSUM" >> $GITHUB_ENV

            - name: Update filter metadata
              run: |
                  sed -i "s/^! Version:.*/! Version: ${{ env.FULL_VERSION }}/" "${{ env.FILTER_FILE }}"
                  sed -i "s/^! Last modified:.*/! Last modified: ${{ env.DATE }}/" "${{ env.FILTER_FILE }}"
                  sed -i "s/^! Checksum:.*/! Checksum: ${{ env.CHECKSUM }}/" "${{ env.FILTER_FILE }}"
                  
                  # Check for changes
                  if git diff --quiet "${{ env.FILTER_FILE }}"; then
                    echo "CHANGED=false" >> $GITHUB_ENV
                  else
                    echo "CHANGED=true" >> $GITHUB_ENV
                  fi

            - name: Generate Simple README
              run: |
                  cat > README.md <<EOF
                  # ðŸ›¡ï¸ Yuusei Filter List
                  
                  **Simple. Fast. Optimized for Vietnam.**
                  
                  - **Version**: ${{ env.FULL_VERSION }}
                  - **Rules**: ${{ env.RULE_COUNT }}
                  - **Last Update**: ${{ env.DATE }}
                  
                  ## ðŸš€ Installation
                  
                  | Filter | Link |
                  | :--- | :--- |
                  | **uBlock / AdGuard** | [Subscribe](https://subscribe.adblockplus.org/?location=https://raw.githubusercontent.com/${{ github.repository }}/main/Yuusei.txt&title=Yuusei%20Filter) |
                  | **Raw URL** | [Yuusei.txt](https://raw.githubusercontent.com/${{ github.repository }}/main/Yuusei.txt) |
                  
                  ## ðŸŒ Web Editor
                  
                  Manage the filter list easily via our [Web Editor](https://${{ github.repository_owner }}.github.io/${{ env.REPO_NAME }}/).
                  
                  ---
                  *Made with â¤ï¸ by ${{ env.AUTHOR_NAME }}*
                  EOF

            - name: Prepare Website
              run: |
                  # Inject Repository Name into index.html
                  sed -i "s|{{REPO_NAME}}|${{ github.repository }}|g" index.html

            - name: Commit changes
              if: env.CHANGED == 'true' || github.event_name == 'workflow_dispatch'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  git add "${{ env.FILTER_FILE }}" README.md
                  # Only commit if there are changes
                  git diff-index --quiet HEAD || git commit -m "chore: update filter and readme [skip ci]"
                  git push

            - name: Upload Pages Artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  path: .

            - name: Deploy to GitHub Pages
              uses: actions/deploy-pages@v4
