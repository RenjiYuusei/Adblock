name: Update Yuusei Filter

on:
    schedule:
    - cron: '0 17 * * *' # 0h GMT+7 (17h UTC)
    workflow_dispatch:
        inputs:
            force_update:
                description: 'Force update'
                required: false 
                type: boolean
                default: false

env:
    FILTER_FILE: Yuusei.txt
    ABPVN_URL: https://abpvn.com/filter/abpvn-oLEiGq.txt
    MIN_RULES: 10
    TIMEZONE: 'Asia/Ho_Chi_Minh'

jobs:
    update-filter:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repo
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup timezone
              run: sudo ln -sf /usr/share/zoneinfo/${{ env.TIMEZONE }} /etc/localtime

            - name: Get ABPVN data
              run: |
                  curl -s -o abpvn.txt "$ABPVN_URL"
                  # Remove unwanted lines
                  sed -i '/^! Last modified:/d;/^\[Adblock Plus 2\.0\]/d' abpvn.txt

            - name: Update metadata
              id: metadata
              run: |
                  CURRENT_DATE=$(TZ=GMT-7 date +'%d-%m-%Y %H:%M:%S')
                  echo "NEW_DATE=$CURRENT_DATE" >> $GITHUB_ENV
                  
                  # Calculate new checksum
                  OLD_CHECKSUM=$(grep '! Checksum:' Yuusei.txt | cut -d' ' -f3)
                  NEW_CHECKSUM=$(sha256sum Yuusei.txt | cut -d' ' -f1)
                  echo "NEW_CHECKSUM=$NEW_CHECKSUM" >> $GITHUB_ENV

            - name: Merge filters
              run: |
                  awk -v date="$NEW_DATE" -v checksum="$NEW_CHECKSUM" -v abpvn="$(cat abpvn.txt)" '
                  BEGIN {in_abpvn=0; in_about=0}
                  /! ----------  AbpVN  ----------/ {in_abpvn=1; print; next}
                  /! ----------  About ----------/ {
                      in_abpvn=0;
                      in_about=1;
                      print "! ----------  About ----------";
                      print "! Version: " strftime("%Y.%m.%d.%H%M");
                      print "! Title: Yuusei";
                      print "! Last modified: " date " (GMT+7)";
                      print "! RenjiYuusei Adblock filter";
                      print "! Copyright: Yuusei";
                      print "! Homepage: https://github.com/RenjiYuusei/Adblock";
                      print "! Checksum: " checksum;
                      print "! License: GPLv3 (https://spdx.org/licenses/GPL-3.0-only.html)";
                      next;
                  }
                  in_abpvn && /^! Last modified:/ {next}
                  in_abpvn && /^https:\/\// {print; print abpvn; in_abpvn=0; next}
                  !in_about {print}
                  ' Yuusei.txt > temp.txt
                  
                  mv temp.txt Yuusei.txt

            - name: Validate rules
              run: |
                  RULES=$(grep -v '^!' Yuusei.txt | wc -l)
                  if [ "$RULES" -lt "$MIN_RULES" ]; then
                      echo "::error::Not enough rules ($RULES < $MIN_RULES)"
                      exit 1
                  fi

            - name: Commit changes
              run: |
                  git config user.name "Auto Updater"
                  git config user.email "auto@yuusei.filter"
                  git add Yuusei.txt
                  git diff --cached --quiet || \
                  git commit -m "ðŸ”„ Auto-update: $NEW_DATE [Checksum: ${NEW_CHECKSUM:0:8}]" && \
                  git push
