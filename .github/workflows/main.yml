name: Update Yuusei Filter

on:
  push:
    paths:
      - 'Yuusei.txt'
  schedule:
    - cron: '0 0,12 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'C·∫≠p nh·∫≠t b·∫Øt bu·ªôc ngay c·∫£ khi kh√¥ng c√≥ thay ƒë·ªïi'
        required: false
        type: boolean
        default: false

env:
  FILTER_FILE: Yuusei.txt
  MIN_RULES: 10
  TIMEZONE: 'Asia/Ho_Chi_Minh'
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  update-filter:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup environment
        id: setup
        run: |
          sudo ln -sf /usr/share/zoneinfo/${{ env.TIMEZONE }} /etc/localtime
          {
            echo "DATE=$(date +'%d-%m-%Y')"
            echo "TIME=$(date +'%H:%M:%S')"
            echo "YEAR=$(date +'%Y')"
            echo "REPO_NAME=${GITHUB_REPOSITORY#*/}"
            echo "AUTHOR_NAME=${GITHUB_REPOSITORY%/*}"
            echo "FULL_VERSION=$(date +'%Y.%m.%d')"
          } >> $GITHUB_ENV
          
      - name: Get contributors info
        id: contributors
        run: |
          # Get all contributors
          contributors=$(gh api graphql -f query='
            query($owner:String!, $name:String!) {
              repository(owner:$owner, name:$name) {
                collaborators(first:100) {
                  nodes {
                    login
                    name
                    avatarUrl
                    url
                    contributionsCollection {
                      totalCommitContributions
                      totalIssueContributions
                      totalPullRequestContributions
                      totalPullRequestReviewContributions
                    }
                  }
                }
              }
            }' -f owner="${GITHUB_REPOSITORY%/*}" -f name="${GITHUB_REPOSITORY#*/}" --jq '.data.repository.collaborators.nodes')
          
          # Format contributors for README
          echo "CONTRIBUTORS<<EOF" >> $GITHUB_ENV
          echo "$contributors" | jq -r '.[] | "- [![\(.login)](\(.avatarUrl)) **[\(.login)](\(.url))** - \(.contributionsCollection.totalCommitContributions + .contributionsCollection.totalIssueContributions + .contributionsCollection.totalPullRequestContributions) ƒë√≥ng g√≥p"' >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Validate and optimize filter file
        id: validate
        run: |
          log_error() {
            echo "::error::$1"
            exit 1
          }
          
          # Ki·ªÉm tra file t·ªìn t·∫°i v√† k√≠ch th∆∞·ªõc
          [ -f "${{ env.FILTER_FILE }}" ] || log_error "Kh√¥ng t√¨m th·∫•y file filter!"
          FILE_SIZE=$(stat -f%z "${{ env.FILTER_FILE }}" 2>/dev/null || stat -c%s "${{ env.FILTER_FILE }}")
          [ "$FILE_SIZE" -ge 100 ] || log_error "File filter qu√° nh·ªè!"
          
          # Ki·ªÉm tra headers b·∫Øt bu·ªôc
          required_headers=("! Title:" "! Version:" "! Last modified:" "! Homepage:" "! License:")
          for header in "${required_headers[@]}"; do
            grep -q "^$header" "${{ env.FILTER_FILE }}" || log_error "Thi·∫øu header b·∫Øt bu·ªôc: $header"
          done
          
          # ƒê·∫øm s·ªë rules
          RULE_COUNT=$(grep -v '^!' "${FILTER_FILE}" | wc -l)
          [ "$RULE_COUNT" -ge "${{ env.MIN_RULES }}" ] || log_error "Kh√¥ng ƒë·ªß rules (t·ªëi thi·ªÉu: ${{ env.MIN_RULES }})!"
          
          # ƒê·∫øm lo·∫°i rules
          {
            echo "RULE_COUNT=$RULE_COUNT"
            echo "NETWORK_RULES=$(grep -c "^||" "${FILTER_FILE}" || true)"
            echo "COSMETIC_RULES=$(grep -c "##" "${FILTER_FILE}" || true)"
            echo "WHITELIST_RULES=$(grep -c "^@@" "${FILTER_FILE}" || true)"
            echo "COMMENT_COUNT=$(grep -c "^!" "${FILTER_FILE}" || true)"
          } >> $GITHUB_ENV
          
          # Ki·ªÉm tra c√∫ ph√°p v√† kho·∫£ng tr·∫Øng th·ª´a trong rules
          SYNTAX_ERRORS=$(grep -v "^!" "${FILTER_FILE}" | grep -n "[^a-zA-Z0-9.*?^$@#|=/,&_-]" || true)
          if [ -n "$SYNTAX_ERRORS" ]; then
            echo "::warning::Ph√°t hi·ªán l·ªói c√∫ ph√°p ti·ªÅm ·∫©n:"
            echo "$SYNTAX_ERRORS"
          fi
          
          # Lo·∫°i b·ªè kho·∫£ng tr·∫Øng th·ª´a trong rule
          sed -i  '/^[^!]/s/[[:space:]]\+/ /g'  "${{ env.FILTER_FILE }}"

      - name: Update filter metadata
        id: update
        run: |
          temp_file=$(mktemp)
          cp "${{ env.FILTER_FILE }}" "${FILTER_FILE}.bak"
          
          # C·∫≠p nh·∫≠t metadata
          sed -E "s/^! Version:.*/! Version: ${{ env.FULL_VERSION }}/;\
                 s/^! Last modified:.*/! Last modified: ${{ env.DATE }} ${{ env.TIME }}/;\
                 s/^! Updated by:.*/! Updated by: GitHub Actions/" \
          "${{ env.FILTER_FILE }}" > "$temp_file"
          
          # T√≠nh to√°n v√† c·∫≠p nh·∫≠t checksum
          CHECKSUM=$(sha256sum "$temp_file" | cut -d' ' -f1)
          sed "s/^! Checksum:.*/! Checksum: $CHECKSUM/" "$temp_file" > "${{ env.FILTER_FILE }}"
          
          # Ki·ªÉm tra thay ƒë·ªïi
          if [[ "${{ github.event.inputs.force_update }}" == "true" ]] || ! git diff --quiet "${{ env.FILTER_FILE }}"; then
            echo "CHANGED=true" >> $GITHUB_ENV
          else
            echo "CHANGED=false" >> $GITHUB_ENV
          fi
          
          rm "$temp_file"
          
      - name: Generate README
        if: env.CHANGED == 'true'
        run: |
          cat > README.md << EOF
          <div align="center">
            <img src=".github/assets/logo.png" width="120" height="120" alt="Yuusei Filter Logo">
            <h1>üõ°Ô∏è Yuusei Filter List</h1>
            <p><em>B·∫£o v·ªá tr·∫£i nghi·ªám web c·ªßa b·∫°n kh·ªèi qu·∫£ng c√°o kh√¥ng mong mu·ªën</em></p>
            <p>
              <a href="https://github.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/releases">
                <img src="https://img.shields.io/badge/version-${{ env.FULL_VERSION }}-blue?style=for-the-badge" alt="Version">
              </a>
              <a href="https://github.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/blob/main/Yuusei.txt">
                <img src="https://img.shields.io/badge/rules-${{ env.RULE_COUNT }}-brightgreen?style=for-the-badge" alt="Rules">
              </a>
              <a href="https://github.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/commits/main">
                <img src="https://img.shields.io/badge/updated-${{ env.DATE }}-success?style=for-the-badge" alt="Updated">
              </a>
            </p>
          </div>

          ## üìä Th·ªëng k√™

          | Lo·∫°i | S·ªë l∆∞·ª£ng |
          |------|-----------|
          | T·ªïng s·ªë Rules | ${{ env.RULE_COUNT }} |
          | Rules M·∫°ng | ${{ env.NETWORK_RULES }} |
          | Rules Giao Di·ªán | ${{ env.COSMETIC_RULES }} |
          | Rules Whitelist | ${{ env.WHITELIST_RULES }} |
          | Ghi ch√∫ & Comments | ${{ env.COMMENT_COUNT }} |

          ## üöÄ C√†i ƒë·∫∑t

          <details>
          <summary>üîç D√†nh cho uBlock Origin</summary>

          ### C√°ch 1: C√†i ƒë·∫∑t nhanh
          1. Click v√†o link: [C√†i ƒë·∫∑t cho uBlock Origin](https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/Yuusei.txt)
          2. Click "Proceed" ho·∫∑c "Ti·∫øp t·ª•c" trong h·ªôp tho·∫°i x√°c nh·∫≠n

          ### C√°ch 2: C√†i ƒë·∫∑t th·ªß c√¥ng
          1. M·ªü Dashboard uBlock Origin
          2. Chuy·ªÉn ƒë·∫øn tab "Filter lists"
          3. Cu·ªôn xu·ªëng cu·ªëi trang
          4. M·ªü r·ªông ph·∫ßn "Custom"
          5. D√°n link sau v√†o √¥ tr·ªëng v√† click "Apply changes":
          \`\`\`
          https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/Yuusei.txt
          \`\`\`
          </details>

          <details>
          <summary>üõ°Ô∏è D√†nh cho AdGuard</summary>

          ### C√°ch 1: C√†i ƒë·∫∑t nhanh
          1. Click v√†o link: [C√†i ƒë·∫∑t cho AdGuard](https://subscribe.adblockplus.org/?location=https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/Yuusei.txt)
          2. Ch·ªçn "Subscribe" trong h·ªôp tho·∫°i x√°c nh·∫≠n

          ### C√°ch 2: C√†i ƒë·∫∑t th·ªß c√¥ng
          1. M·ªü c√†i ƒë·∫∑t AdGuard
          2. Ch·ªçn "Filters" > "Custom"
          3. Click "Add custom filter"
          4. D√°n link sau v√† click "Next":
          \`\`\`
          https://raw.githubusercontent.com/${{ env.AUTHOR_NAME }}/${{ env.REPO_NAME }}/main/Yuusei.txt
          \`\`\`
          </details>

          ## üë• Ng∆∞·ªùi ƒë√≥ng g√≥p

          ### Nh·ªØng ng∆∞·ªùi ƒë√≥ng g√≥p ch√≠nh

          ${{ env.CONTRIBUTORS }}

          ## üìù C·∫≠p nh·∫≠t

          - **C·∫≠p nh·∫≠t l·∫ßn cu·ªëi**: ${{ env.DATE }} ${{ env.TIME }}
          - **Phi√™n b·∫£n hi·ªán t·∫°i**: ${{ env.FULL_VERSION }}
          - **T·ªïng s·ªë rules**: ${{ env.RULE_COUNT }}

          ### Changelog g·∫ßn ƒë√¢y
          \`\`\`
          $(git log -3 --pretty=format:"- %h %s (%cr)" --abbrev-commit)
          \`\`\`

          ## ‚≠ê T√≠nh nƒÉng

          - ‚ú® **T·ªëi ∆∞u cho ng∆∞·ªùi Vi·ªát**: Rules ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·∫∑c bi·ªát cho c√°c website Vi·ªát Nam
          - üöÄ **Hi·ªáu su·∫•t cao**: Rules ƒë∆∞·ª£c t·ªëi ∆∞u h√≥a ƒë·ªÉ gi·∫£m thi·ªÉu t√°c ƒë·ªông ƒë·∫øn t·ªëc ƒë·ªô duy·ªát web
          - üîÑ **C·∫≠p nh·∫≠t th∆∞·ªùng xuy√™n**: B·ªô l·ªçc ƒë∆∞·ª£c c·∫≠p nh·∫≠t 2 l·∫ßn/ng√†y
          - üõ°Ô∏è **An to√†n**: Kh√¥ng ch·ª©a m√£ ƒë·ªôc h·∫°i
          - üì± **ƒêa n·ªÅn t·∫£ng**: Ho·∫°t ƒë·ªông tr√™n m·ªçi tr√¨nh duy·ªát v√† thi·∫øt b·ªã

          ## üìú Gi·∫•y ph√©p

          D·ª± √°n n√†y ƒë∆∞·ª£c ph√¢n ph·ªëi d∆∞·ªõi [Gi·∫•y ph√©p MIT](LICENSE)

          ---
          <div align="center">
            <sub>Made with ‚ù§Ô∏è by <a href="https://github.com/${{ env.AUTHOR_NAME }}">${{ env.AUTHOR_NAME }}</a></sub>
          </div>
          EOF

      - name: Commit changes
        if: env.CHANGED == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "${{ env.FILTER_FILE }}" README.md .github/assets/logo.png
          git commit -m "üîÑ C·∫≠p nh·∫≠t t·ª± ƒë·ªông (Phi√™n b·∫£n: ${{ env.FULL_VERSION }})"
          git pull origin main --rebase
          git push
