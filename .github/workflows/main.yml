name: Cáº­p nháº­t Bá»™ lá»c & Triá»ƒn khai Web

on:
    schedule:
        - cron: '0 0 * * *' # Cháº¡y hÃ ng ngÃ y vÃ o lÃºc 00:00 UTC (07:00 VN)
    push:
        paths:
            - 'Yuusei.txt'
            - 'index.html'
            - 'update_filters.py'
            - 'requirements.txt'
            - '.github/workflows/main.yml'
    workflow_dispatch:
        inputs:
            force_update:
                description: 'Cáº­p nháº­t báº¯t buá»™c'
                required: false
                type: boolean
                default: false

env:
    FILTER_FILE: Yuusei.txt
    TIMEZONE: 'Asia/Ho_Chi_Minh'

permissions:
    contents: write
    pages: write
    id-token: write
    pull-requests: write

jobs:
    update-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Thiáº¿t láº­p mÃ´i trÆ°á»ng
              run: |
                  sudo ln -sf /usr/share/zoneinfo/${{ env.TIMEZONE }} /etc/localtime
                  echo "DATE=$(date +'%d-%m-%Y')" >> $GITHUB_ENV
                  echo "FULL_VERSION=$(date +'%Y.%m.%d.%H%M')" >> $GITHUB_ENV
                  echo "REPO_NAME=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV
                  echo "AUTHOR_NAME=${GITHUB_REPOSITORY%/*}" >> $GITHUB_ENV

            - name: CÃ i Ä‘áº·t Python Dependencies
              run: |
                  if [ -f requirements.txt ]; then pip install -r requirements.txt; else pip install requests; fi

            - name: Cháº¡y script cáº­p nháº­t bá»™ lá»c (AbpVN)
              run: |
                  python update_filters.py

            - name: Kiá»ƒm tra thay Ä‘á»•i vÃ  thá»‘ng kÃª
              id: stats
              run: |
                  # Äáº¿m sá»‘ quy táº¯c
                  RULE_COUNT=$(grep -cvE '^!|^$' "${FILTER_FILE}")
                  echo "RULE_COUNT=$RULE_COUNT" >> $GITHUB_ENV
                  
                  # TÃ­nh checksum
                  CHECKSUM=$(sha256sum "${FILTER_FILE}" | cut -d' ' -f1)
                  echo "CHECKSUM=$CHECKSUM" >> $GITHUB_ENV
                  
                  # Kiá»ƒm tra git status
                  if git diff --quiet "${{ env.FILTER_FILE }}"; then
                    echo "CHANGED=false" >> $GITHUB_ENV
                  else
                    echo "CHANGED=true" >> $GITHUB_ENV
                  fi

            - name: Táº¡o README.md (Tiáº¿ng Viá»‡t)
              run: |
                  cat > README.md <<EOF
                  # ðŸ›¡ï¸ Yuusei Filter List
                  
                  **Bá»™ lá»c quáº£ng cÃ¡o Ä‘Æ¡n giáº£n, hiá»‡u quáº£, tá»‘i Æ°u cho ngÆ°á»i Viá»‡t.**
                  
                  - **PhiÃªn báº£n**: ${{ env.FULL_VERSION }}
                  - **Sá»‘ lÆ°á»£ng quy táº¯c**: ${{ env.RULE_COUNT }}
                  - **Cáº­p nháº­t láº§n cuá»‘i**: ${{ env.DATE }}
                  - **Checksum**: \`${{ env.CHECKSUM }}\`
                  
                  ## ðŸš€ CÃ i Äáº·t
                  
                  | TrÃ¬nh cháº·n | LiÃªn káº¿t cÃ i Ä‘áº·t nhanh |
                  | :--- | :--- |
                  | **uBlock / AdGuard** | [Nháº¥n Ä‘á»ƒ CÃ i Ä‘áº·t](https://subscribe.adblockplus.org/?location=https://raw.githubusercontent.com/${{ github.repository }}/main/Yuusei.txt&title=Yuusei%20Filter) |
                  | **LiÃªn káº¿t trá»±c tiáº¿p** | [Yuusei.txt](https://raw.githubusercontent.com/${{ github.repository }}/main/Yuusei.txt) |
                  
                  ## ðŸŒ TrÃ¬nh Chá»‰nh Sá»­a Web
                  
                  Báº¡n cÃ³ thá»ƒ xem vÃ  chá»‰nh sá»­a bá»™ lá»c trá»±c tiáº¿p thÃ´ng qua [Trang Web Editor](https://${{ github.repository_owner }}.github.io/${{ env.REPO_NAME }}/).
                  
                  TÃ­nh nÄƒng:
                  - âœï¸ Chá»‰nh sá»­a trá»±c tuyáº¿n.
                  - ðŸ”„ Tá»± Ä‘á»™ng cáº­p nháº­t tá»« nguá»“n AbpVN.
                  - ðŸ‡»ðŸ‡³ Giao diá»‡n Tiáº¿ng Viá»‡t thÃ¢n thiá»‡n.
                  
                  ## â„¹ï¸ ThÃ´ng tin
                  
                  Bá»™ lá»c nÃ y tá»± Ä‘á»™ng tá»•ng há»£p cÃ¡c quy táº¯c tá»« **AbpVN** vÃ  cÃ¡c quy táº¯c tÃ¹y chá»‰nh cá»§a **Yuusei**.
                  
                  ---
                  *ÄÆ°á»£c phÃ¡t triá»ƒn bá»Ÿi ${{ env.AUTHOR_NAME }}*
                  EOF

            - name: Chuáº©n bá»‹ trang Web
              run: |
                  # ChÃ¨n tÃªn repository vÃ o index.html Ä‘á»ƒ API hoáº¡t Ä‘á»™ng
                  sed -i "s|{{REPO_NAME}}|${{ github.repository }}|g" index.html

            - name: Commit vÃ  Push thay Ä‘á»•i (Update & Deploy)
              if: env.CHANGED == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  git add "${{ env.FILTER_FILE }}" README.md

                  # Commit náº¿u cÃ³ thay Ä‘á»•i
                  git diff-index --quiet HEAD || git commit -m "chore: cáº­p nháº­t bá»™ lá»c v${{ env.FULL_VERSION }}"
                  git push

            - name: Upload Artifact cho Pages
              uses: actions/upload-pages-artifact@v3
              with:
                  path: .

            - name: Deploy lÃªn GitHub Pages
              uses: actions/deploy-pages@v4

