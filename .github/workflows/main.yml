name: Update Yuusei Filter

on:
    push:
        paths:
            - 'Yuusei.txt'
    schedule:
        - cron: '0 0 * * *' # Ch·∫°y v√†o 0h h√†ng ng√†y (GMT+7)
    workflow_dispatch:
        inputs:
            force_update:
                description: 'C·∫≠p nh·∫≠t b·∫Øt bu·ªôc ngay c·∫£ khi kh√¥ng c√≥ thay ƒë·ªïi'
                required: false
                type: boolean
                default: false

env:
    FILTER_FILE: Yuusei.txt
    ABPVN_URL: https://abpvn.com/filter/abpvn-oLEiGq.txt
    MIN_RULES: 10
    TIMEZONE: 'Asia/Ho_Chi_Minh'
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
    update-filter:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: T·∫£i b·ªô l·ªçc ABPVN v√† lo·∫°i b·ªè d√≤ng kh√¥ng mong mu·ªën
              run: |
                  curl -s -o abpvn.txt ${{ env.ABPVN_URL }}
                  # Lo·∫°i b·ªè hai d√≤ng c·ª• th·ªÉ
                  sed -i '/^! Last modified:/d' abpvn.txt
                  sed -i '/^\[Adblock Plus 2.0\]/d' abpvn.txt

            - name: C·∫≠p nh·∫≠t Yuusei.txt v·ªõi n·ªôi dung ABPVN ƒë√£ x·ª≠ l√Ω
              run: |
                  awk -v abpvn="$(cat abpvn.txt)" '
                  /! ----------  AbpVN  ----------/ { 
                      print; getline; print; printf "%s\n", abpvn; skip=1; next 
                  }
                  /! ----------  About ----------/ { skip=0 }
                  !skip' Yuusei.txt > temp.txt
                  mv temp.txt Yuusei.txt

            - name: C·∫≠p nh·∫≠t Last modified v√† Checksum trong ph·∫ßn About
              run: |
                  current_date=$(TZ=${{ env.TIMEZONE }} date +'%d-%m-%Y %H:%M:%S')
                  # C·∫≠p nh·∫≠t Last modified
                  sed -i "s/! Last modified:.*/! Last modified: $current_date (GMT+7)/" Yuusei.txt
                  # T√≠nh to√°n checksum (lo·∫°i b·ªè d√≤ng checksum c≈© ƒë·ªÉ tr√°nh ·∫£nh h∆∞·ªüng)
                  checksum=$(sed '/^! Checksum:/d' Yuusei.txt | md5sum | cut -d' ' -f1)
                  # C·∫≠p nh·∫≠t ho·∫∑c th√™m d√≤ng Checksum
                  if grep -q "^! Checksum:" Yuusei.txt; then
                      sed -i "s/! Checksum:.*/! Checksum: $checksum/" Yuusei.txt
                  else
                      sed -i "/! Last modified:.*/a ! Checksum: $checksum" Yuusei.txt
                  fi

            - name: Validate and analyze filter file
              run: |
                  [ -f "${{ env.FILTER_FILE }}" ] || exit 1
                  cp "${{ env.FILTER_FILE }}" "${FILTER_FILE}.bak"
                  # Ki·ªÉm tra s·ªë l∆∞·ª£ng rule
                  RULE_COUNT=$(grep -v '^!' "${FILTER_FILE}" | wc -l)
                  if [ "$RULE_COUNT" -lt "${{ env.MIN_RULES }}" ]; then
                      echo "::error::Kh√¥ng ƒë·ªß rules (t·ªëi thi·ªÉu: ${{ env.MIN_RULES }})!"
                      exit 1
                  fi

            - name: Commit changes
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  git diff --quiet || (git add Yuusei.txt && git commit -m "üîÑ C·∫≠p nh·∫≠t d·ªØ li·ªáu ABPVN t·ª± ƒë·ªông" && git push)
