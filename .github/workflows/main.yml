name: Update Yuusei Filter

on:
    push:
        paths:
            - 'Yuusei.txt'
    schedule:
    - cron: '0 0 * * *' # Cháº¡y vÃ o 0h hÃ ng ngÃ y (GMT+7)
    workflow_dispatch:
        inputs:
            force_update:
                description: 'Cáº­p nháº­t báº¯t buá»™c ngay cáº£ khi khÃ´ng cÃ³ thay Ä‘á»•i'
                required: false
                type: boolean
                default: false

env:
    FILTER_FILE: Yuusei.txt
    ABPVN_URL: https://abpvn.com/filter/abpvn-oLEiGq.txt
    MIN_RULES: 10
    TIMEZONE: 'Asia/Ho_Chi_Minh'
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
    update-filter:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Táº£i bá»™ lá»c ABPVN
              run: |
                  curl -s -o abpvn.txt ${{ env.ABPVN_URL }}
                  # Loáº¡i bá» GMT+7 vÃ  header khÃ´ng cáº§n thiáº¿t
                  sed -i '/^!/d;/modified:/d' abpvn.txt

            - name: Cáº­p nháº­t Yuusei.txt
              run: |
                  current_date=$(date +'%d-%m-%Y %H:%M:%S')
                  awk -v date="$current_date" -v abpvn="$(cat abpvn.txt)" '
                  /! ----------  AbpVN  ----------/ { 
                      print; getline; print; print "! Last modified: " date; printf "%s\n", abpvn; skip=1; next 
                  }
                  /! ----------  About ----------/ { skip=0 }
                  !skip' Yuusei.txt > temp.txt
                  mv temp.txt Yuusei.txt

            - name: Validate and analyze filter file
              run: |
                  [ -f "${{ env.FILTER_FILE }}" ] || exit 1
                  cp "${{ env.FILTER_FILE }}" "${FILTER_FILE}.bak"
                  
                  # Kiá»ƒm tra sá»‘ lÆ°á»£ng rule
                  RULE_COUNT=$(grep -v '^!' "${FILTER_FILE}" | wc -l)
                  if [ "$RULE_COUNT" -lt "${{ env.MIN_RULES }}" ]; then
                      echo "::error::KhÃ´ng Ä‘á»§ rules (tá»‘i thiá»ƒu: ${{ env.MIN_RULES }})!"
                      exit 1
                  fi

            - name: Commit changes
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  git diff --quiet || (git add Yuusei.txt && git commit -m "ðŸ”„ Cáº­p nháº­t dá»¯ liá»‡u ABPVN tá»± Ä‘á»™ng" && git push)
