name: Update Yuusei Filter

on:
    push:
        paths:
            - 'Yuusei.txt'
    schedule:
    - cron: '0 0 * * *' # Chạy vào 0h hàng ngày (GMT+7)
    workflow_dispatch:
        inputs:
            force_update:
                description: 'Cập nhật bắt buộc ngay cả khi không có thay đổi'
                required: false
                type: boolean
                default: false

env:
    FILTER_FILE: Yuusei.txt
    ABPVN_URL: https://abpvn.com/filter/abpvn-oLEiGq.txt
    MIN_RULES: 10
    TIMEZONE: 'Asia/Ho_Chi_Minh'
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
    update-filter:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Tải bộ lọc ABPVN
              run: |
                  curl -s -o abpvn.txt ${{ env.ABPVN_URL }}
                  # Loại bỏ GMT+7 và header không cần thiết
                  sed -i '/^!/d;/modified:/d' abpvn.txt

            - name: Cập nhật Yuusei.txt
              run: |
                  current_date=$(date +'%d-%m-%Y %H:%M:%S')
                  awk -v date="$current_date" -v abpvn="$(cat abpvn.txt)" '
                  /! ----------  AbpVN  ----------/ { 
                      print; getline; print; print "! Last modified: " date; printf "%s\n", abpvn; skip=1; next 
                  }
                  /! ----------  About ----------/ { skip=0 }
                  !skip' Yuusei.txt > temp.txt
                  mv temp.txt Yuusei.txt

            - name: Validate and analyze filter file
              run: |
                  [ -f "${{ env.FILTER_FILE }}" ] || exit 1
                  cp "${{ env.FILTER_FILE }}" "${FILTER_FILE}.bak"
                  
                  # Kiểm tra số lượng rule
                  RULE_COUNT=$(grep -v '^!' "${FILTER_FILE}" | wc -l)
                  if [ "$RULE_COUNT" -lt "${{ env.MIN_RULES }}" ]; then
                      echo "::error::Không đủ rules (tối thiểu: ${{ env.MIN_RULES }})!"
                      exit 1
                  fi

            - name: Commit changes
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  git diff --quiet || (git add Yuusei.txt && git commit -m "🔄 Cập nhật dữ liệu ABPVN tự động" && git push)
