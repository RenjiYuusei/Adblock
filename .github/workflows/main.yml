name: Update Yuusei.txt

on:
  push:
    paths:
      - 'Yuusei.txt'
  schedule:
    - cron: '0 0 * * *'  # Fixed cron syntax: Run daily at 00:00 UTC
  workflow_dispatch:

jobs:
  update-file:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Explicitly declare required permissions
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Optimize git checkout by fetching only the latest commit

      - name: Set up timezone and datetime
        run: |
          sudo ln -sf /usr/share/zoneinfo/Asia/Ho_Chi_Minh /etc/localtime
          echo "DATE=$(date +"%d-%m-%Y")" >> $GITHUB_ENV
          echo "TIME=$(date +"%H:%M:%S")" >> $GITHUB_ENV

      - name: Update file metadata and calculate checksum
        id: update_file
        run: |
          # Create temporary file to avoid in-place sed issues
          temp_file=$(mktemp)
          
          # Update Version, Last modified, and calculate new checksum
          sed -E "
            s/^! Version:.*/! Version: ${{ env.DATE }}/
            s/^! Last modified:.*/! Last modified: ${{ env.DATE }} ${{ env.TIME }}/
          " Yuusei.txt > "$temp_file"
          
          # Calculate new checksum from the updated content
          CHECKSUM=$(sha256sum "$temp_file" | cut -d' ' -f1)
          sed "s/^! Checksum:.*/! Checksum: $CHECKSUM/" "$temp_file" > Yuusei.txt
          
          # Check for changes
          if git diff --quiet Yuusei.txt; then
            echo "CHANGED=false" >> $GITHUB_ENV
            echo "No changes detected in Yuusei.txt"
          else
            echo "CHANGED=true" >> $GITHUB_ENV
            echo "Changes detected in Yuusei.txt"
          fi
          
          rm "$temp_file"

      - name: Commit and push changes
        if: env.CHANGED == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Yuusei.txt
          git commit -m "Auto update Yuusei.txt (Version: ${{ env.DATE }})"
          git push
