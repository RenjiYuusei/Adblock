name: Update Yuusei Filter

on:
  push:
    paths:
      - 'Yuusei.txt'
  schedule:
    - cron: '0 0 * * *' # Ch·∫°y h√†ng ng√†y l√∫c 0:00 (GMT+7)
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Bu·ªôc c·∫≠p nh·∫≠t ngay c·∫£ khi kh√¥ng c√≥ thay ƒë·ªïi'
        required: false
        type: boolean
        default: false

env:
  FILTER_FILE: Yuusei.txt
  ABPVN_URL: https://abpvn.com/filter/abpvn-oLEiGq.txt
  MIN_RULES: 10
  TIMEZONE: 'Asia/Ho_Chi_Minh'
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  update-filter:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: T·∫£i v√† x·ª≠ l√Ω t·ªáp ABPVN
        run: |
          curl -s -o abpvn.txt ${{ env.ABPVN_URL }}
          # Lo·∫°i b·ªè c√°c d√≤ng kh√¥ng mong mu·ªën
          sed -i '/^! Checksum:/d' abpvn.txt
          sed -i '/^! Version:/d' abpvn.txt
          sed -i '/^! id:/d' abpvn.txt
          sed -i '/^! Title:/d' abpvn.txt

      - name: C·∫≠p nh·∫≠t t·ªáp Yuusei.txt v·ªõi c·∫•u tr√∫c m·ªõi
        run: |
          current_date=$(TZ=${{ env.TIMEZONE }} date +'%d-%m-%Y %H:%M:%S')
          # T·∫°o t·ªáp Yuusei.txt m·ªõi v·ªõi c√°c ph·∫ßn theo th·ª© t·ª±: About, Yuusei, AbpVN
          echo "! ----------  About ----------" > Yuusei.txt
          echo "! Version: 2025.02.25.0747" >> Yuusei.txt
          echo "! Title: Yuusei" >> Yuusei.txt
          echo "! Last modified: $current_date (GMT+7)" >> Yuusei.txt
          echo "! RenjiYuusei Adblock filter" >> Yuusei.txt
          echo "! Copyright: Yuusei" >> Yuusei.txt
          echo "! Homepage: https://github.com/RenjiYuusei/Adblock" >> Yuusei.txt
          echo "! License: GPLv3 (https://spdx.org/licenses/GPL-3.0-only.html)" >> Yuusei.txt
          echo "! ----------  Yuusei  ----------" >> Yuusei.txt
          # Th√™m n·ªôi dung Yuusei (v√≠ d·ª•: b·∫°n c√≥ th·ªÉ tr√≠ch xu·∫•t t·ª´ t·ªáp c≈© ho·∫∑c th√™m th·ªß c√¥ng)
          echo "[N·ªôi dung Yuusei]" >> Yuusei.txt
          echo "! ----------  AbpVN  ----------" >> Yuusei.txt
          cat abpvn.txt >> Yuusei.txt

      - name: T√≠nh to√°n v√† c·∫≠p nh·∫≠t checksum (n·∫øu c·∫ßn)
        run: |
          checksum=$(sed '/^! Checksum:/d' Yuusei.txt | md5sum | cut -d' ' -f1)
          sed -i "/! Last modified:.*/a ! Checksum: $checksum" Yuusei.txt

      - name: Ki·ªÉm tra v√† ph√¢n t√≠ch t·ªáp b·ªô l·ªçc
        run: |
          [ -f "${{ env.FILTER_FILE }}" ] || exit 1
          cp "${{ env.FILTER_FILE }}" "${FILTER_FILE}.bak"
          # Ki·ªÉm tra s·ªë l∆∞·ª£ng quy t·∫Øc
          RULE_COUNT=$(grep -v '^!' "${FILTER_FILE}" | wc -l)
          if [ "$RULE_COUNT" -lt "${{ env.MIN_RULES }}" ]; then
            echo "::error::Kh√¥ng ƒë·ªß quy t·∫Øc (t·ªëi thi·ªÉu: ${{ env.MIN_RULES }})!"
            exit 1
          fi

      - name: Commit thay ƒë·ªïi
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git diff --quiet || (git add Yuusei.txt && git commit -m "üîÑ C·∫≠p nh·∫≠t t·ª± ƒë·ªông ABPVN" && git push)
