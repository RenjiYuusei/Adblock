name: Update Yuusei Filter

on:
    schedule:
    - cron: '0 17 * * *' # 0h GMT+7 (17h UTC)
    workflow_dispatch:
        inputs:
            force_update:
                description: 'Force update'
                required: false
                type: boolean
                default: false

env:
    FILTER_FILE: Yuusei.txt
    ABPVN_URL: https://abpvn.com/filter/abpvn-oLEiGq.txt
    MIN_RULES: 10
    TIMEZONE: 'Asia/Ho_Chi_Minh'

jobs:
    update-filter:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Setup timezone
              run: sudo ln -sf /usr/share/zoneinfo/${{ env.TIMEZONE }} /etc/localtime

            - name: Get ABPVN data
              run: |
                  # Táº£i vÃ  lÃ m sáº¡ch dá»¯ liá»‡u ABPVN
                  curl -s -o abpvn.txt "$ABPVN_URL"
                  sed -i '/^! Last modified:/d;/^\[Adblock Plus 2\.0\]/d;/^$/d' abpvn.txt

            - name: Prepare metadata
              id: metadata
              run: |
                  # Táº¡o metadata má»›i
                  CURRENT_DATE=$(date +'%d-%m-%Y %H:%M:%S')' (GMT+7)'
                  VERSION=$(date +'%Y.%m.%d.%H%M')
                  echo "CURRENT_DATE=$CURRENT_DATE" >> $GITHUB_ENV
                  echo "VERSION=$VERSION" >> $GITHUB_ENV

            - name: Merge and update
              run: |
                  # Merge dá»¯ liá»‡u vÃ  cáº­p nháº­t metadata
                  awk -v version="$VERSION" -v date="$CURRENT_DATE" -v abpvn="$(cat abpvn.txt)" '
                  BEGIN {in_abpvn = 0; abpvn_printed = 0}
                  /! ----------  AbpVN  ----------/ {
                      in_abpvn = 1
                      print
                      next
                  }
                  /! ----------  About ----------/ {
                      in_abpvn = 0
                      print "! ----------  About ----------"
                      print "! Version: " version
                      print "! Title: Yuusei"
                      print "! Last modified: " date
                      print "! RenjiYuusei Adblock filter"
                      print "! Copyright: Yuusei"
                      print "! Homepage: https://github.com/RenjiYuusei/Adblock"
                      print "! License: GPLv3 (https://spdx.org/licenses/GPL-3.0-only.html)"
                      next
                  }
                  in_abpvn && /^https:\/\// {
                      print
                      print abpvn
                      abpvn_printed = 1
                      in_abpvn = 0
                      next
                  }
                  !in_abpvn {print}
                  ' Yuusei.txt > temp.txt

                  # TÃ­nh checksum sau khi merge
                  CHECKSUM=$(sha256sum temp.txt | cut -d' ' -f1)
                  sed -i "s/! Checksum:.*/! Checksum: $CHECKSUM/" temp.txt
                  mv temp.txt Yuusei.txt

            - name: Validate rules
              run: |
                  # Kiá»ƒm tra sá»‘ lÆ°á»£ng rules
                  RULES=$(grep -vc '^!' Yuusei.txt)
                  if [ "$RULES" -lt "$MIN_RULES" ]; then
                      echo "::error::KhÃ´ng Ä‘á»§ rules ($RULES < $MIN_RULES)"
                      exit 1
                  fi

            - name: Commit changes
              run: |
                  git config user.name "Auto Updater"
                  git config user.email "auto@yuusei.filter"
                  git add Yuusei.txt
                  git diff --cached --quiet || \
                  git commit -m "ðŸ”„ Cáº­p nháº­t tá»± Ä‘á»™ng - $CURRENT_DATE" && \
                  git push
